<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Maze of Verbs ‚Äî Hedge</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden;background:#0a1a04;font-family:'Nunito',sans-serif;user-select:none;-webkit-user-select:none}
#G{position:relative;width:100%;height:100%}
canvas{display:block;position:absolute;inset:0;width:100%;height:100%;cursor:pointer}
#hud{position:absolute;top:0;left:0;right:0;height:66px;display:flex;align-items:center;gap:8px;padding:6px 12px;z-index:50;pointer-events:none;background:linear-gradient(180deg,rgba(0,20,0,.85)0%,transparent)}
.av{width:54px;height:54px;border:3px solid #7ec850;border-radius:50%;background:radial-gradient(#2a5a10,#0a1e04);display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 0 16px rgba(126,200,80,.5);flex-shrink:0;position:relative;pointer-events:all;cursor:pointer}
.av-lv{position:absolute;bottom:-3px;right:-3px;background:#7ec850;color:#0a1e04;font-family:'Cinzel',serif;font-size:9px;font-weight:900;border-radius:7px;padding:1px 5px}
.hstat{display:flex;flex-direction:column;gap:4px;flex-shrink:0}
.hrow{display:flex;align-items:center;gap:5px;position:relative}
.hrow .hlabel{font-family:'Cinzel',serif;font-size:8px;letter-spacing:.5px;color:rgba(255,255,255,.55);text-transform:uppercase;min-width:28px;flex-shrink:0}
.hbar{width:90px;height:12px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);border-radius:6px;overflow:hidden;flex-shrink:0}
.hbar-fill{height:100%;border-radius:6px;transition:width .4s}
.hbar-fill.hp{background:linear-gradient(90deg,#c62828,#f44336,#ff8a65)}
.hbar-fill.xp{background:linear-gradient(90deg,#2e7d32,#4caf50,#a5d6a7)}
.hval{font-size:11px;color:rgba(255,255,255,.85);font-weight:700;min-width:32px;font-family:'Cinzel',serif}
.hrow[data-tip]{cursor:help;pointer-events:all}
.hrow[data-tip]:hover::after{content:attr(data-tip);position:absolute;top:calc(100% + 6px);left:0;background:rgba(5,15,2,.97);border:1px solid rgba(126,200,80,.5);border-radius:8px;padding:6px 12px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#7ec850;white-space:nowrap;z-index:200;pointer-events:none}
.hmid{flex:1;display:flex;flex-direction:column;gap:3px;min-width:0}
.hlbl{font-family:'Cinzel',serif;font-size:8px;letter-spacing:2px;color:#7ec850;text-transform:uppercase;text-shadow:0 1px 3px rgba(0,0,0,.9)}
.hpbg{width:100%;height:14px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);border-radius:8px;overflow:hidden;position:relative}
.hpfg{height:100%;background:linear-gradient(90deg,#2e7d32,#66bb6a,#a5d6a7);border-radius:8px;transition:width .7s cubic-bezier(.34,1.56,.64,1)}
.hptxt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:10px;font-weight:700;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.9)}
.htimer{font-family:'Cinzel',serif;font-size:15px;font-weight:700;color:#a8e060;background:rgba(0,0,0,.5);border:1px solid rgba(126,200,80,.3);border-radius:8px;padding:4px 10px;letter-spacing:1px;flex-shrink:0}
.hcurs{display:flex;gap:6px;flex-shrink:0}
.hcur{display:flex;align-items:center;gap:4px;background:rgba(0,0,0,.55);border:2px solid rgba(255,255,255,.12);border-radius:20px;padding:4px 10px;font-family:'Cinzel',serif;font-weight:700;font-size:12px}
.hcur.c{color:#ffd54f;border-color:rgba(255,213,79,.3)}
.hcur.g{color:#e879f9;border-color:rgba(232,121,249,.3)}
#toolpanel{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:7px;z-index:50;background:rgba(4,18,2,.9);border:2px solid rgba(126,200,80,.32);border-radius:18px;padding:10px 7px;box-shadow:0 4px 24px rgba(0,0,0,.7)}
.tp-title{font-family:'Cinzel',serif;font-size:8px;letter-spacing:2px;color:rgba(126,200,80,.55);text-transform:uppercase;text-align:center;margin-bottom:3px}
.ts{width:58px;height:58px;border-radius:14px;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.1);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .18s;position:relative}
.ts:hover{background:rgba(126,200,80,.16);border-color:rgba(126,200,80,.5);transform:scale(1.06)}
.ts.on{background:rgba(126,200,80,.24);border-color:#7ec850;box-shadow:0 0 18px rgba(126,200,80,.5)}
.ts.dim{opacity:.28;cursor:not-allowed;pointer-events:none}
.ts-ico{font-size:24px;line-height:1}
.ts-nm{font-size:7px;font-weight:800;color:rgba(255,255,255,.58);text-transform:uppercase;margin-top:2px}
.ts-cnt{position:absolute;top:-5px;right:-5px;background:#7ec850;color:#0a1e04;font-size:10px;font-weight:900;border-radius:10px;padding:0 5px;font-family:'Cinzel',serif;min-width:18px;text-align:center}
.ts-tooltip{position:absolute;right:calc(100% + 14px);top:50%;transform:translateY(-50%);background:rgba(4,18,2,.97);border:2px solid rgba(126,200,80,.45);border-radius:10px;padding:8px 12px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#fff;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .18s;z-index:100;min-width:180px}
.ts-tooltip .tt-title{font-family:'Cinzel',serif;font-size:11px;font-weight:700;color:#7ec850;margin-bottom:4px}
.ts-tooltip .tt-works{font-size:11px;color:rgba(255,255,255,.75)}
.ts-tooltip .tt-tip{font-size:10px;color:rgba(180,255,180,.8);margin-top:3px;font-style:italic}
.ts:hover .ts-tooltip{opacity:1}
#mm{position:absolute;top:72px;left:10px;width:108px;height:108px;background:rgba(4,18,2,.9);border:2px solid rgba(126,200,80,.35);border-radius:10px;z-index:45;overflow:hidden}
#mmcv{width:100%;height:100%}
#lvbadge{position:absolute;top:72px;left:126px;background:rgba(4,18,2,.9);border:2px solid rgba(126,200,80,.4);border-radius:8px;padding:4px 12px;font-family:'Cinzel',serif;font-size:10px;font-weight:700;color:#7ec850;z-index:45;letter-spacing:2px}
#qpanel{position:absolute;bottom:66px;left:10px;background:rgba(4,18,2,.92);border:2px solid rgba(126,200,80,.32);border-radius:12px;padding:10px 14px;z-index:45;max-width:210px}
.qp-h{font-family:'Cinzel',serif;font-size:9px;letter-spacing:3px;color:#7ec850;text-transform:uppercase;margin-bottom:6px}
.qp-r{display:flex;align-items:center;gap:8px;margin-bottom:4px;font-size:12px;font-weight:700;color:rgba(255,255,255,.82);line-height:1.3}
.qp-r.done{color:rgba(90,200,70,.8)}
.qp-r .qi{font-size:15px;flex-shrink:0}
#wrongtool{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:rgba(8,2,2,.97);border:3px solid #e53935;border-radius:16px;padding:18px 32px;z-index:190;text-align:center;pointer-events:none;transition:transform .3s cubic-bezier(.34,1.56,.64,1);max-width:380px;width:90%}
#wrongtool.show{transform:translate(-50%,-50%) scale(1)}
#wrongtool .wt-ico{font-size:38px;display:block;margin-bottom:6px}
#wrongtool .wt-title{font-family:'Cinzel',serif;font-size:17px;font-weight:700;color:#ff5252;margin-bottom:6px}
#wrongtool .wt-msg{font-family:'Nunito',sans-serif;font-size:14px;color:rgba(255,200,200,.85);line-height:1.5}
#wrongtool .wt-suggest{font-family:'Cinzel',serif;font-size:13px;color:#7ec850;margin-top:8px;padding:6px 12px;background:rgba(126,200,80,.12);border-radius:8px;border:1px solid rgba(126,200,80,.3)}
#bbar{position:absolute;bottom:0;left:0;right:0;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;z-index:50;background:linear-gradient(0deg,rgba(0,10,0,.7)0%,transparent)}
.bb{background:rgba(4,14,2,.88);border:2px solid rgba(126,200,80,.3);border-radius:9px;color:#7ec850;font-family:'Cinzel',serif;font-size:10px;letter-spacing:1px;padding:8px 14px;cursor:pointer;transition:all .2s;text-transform:uppercase;font-weight:700;pointer-events:all}
.bb:hover{border-color:#7ec850;box-shadow:0 0 10px rgba(126,200,80,.3)}
#bbhint{font-family:'Cinzel',serif;font-size:8px;letter-spacing:1px;color:rgba(126,200,80,.45);text-align:center;flex:1;text-transform:uppercase}
#spch{position:absolute;background:rgba(255,252,240,.97);border:3px solid #7ec850;border-radius:14px;padding:10px 13px;font-size:13px;font-weight:700;color:#1a3a06;max-width:185px;z-index:55;box-shadow:0 4px 16px rgba(0,0,0,.5);display:none;pointer-events:none;line-height:1.4}
#spch::after{content:'';position:absolute;bottom:-11px;left:18px;border-left:10px solid transparent;border-right:10px solid transparent;border-top:11px solid #7ec850}
#achtoast{position:fixed;top:72px;left:50%;transform:translateX(-50%) translateY(-130px);background:linear-gradient(135deg,rgba(4,18,2,.97),rgba(10,30,4,.97));border:2px solid #7ec850;border-radius:14px;padding:12px 22px;z-index:200;display:flex;align-items:center;gap:12px;transition:transform .5s cubic-bezier(.34,1.56,.64,1);pointer-events:none}
#achtoast.show{transform:translateX(-50%) translateY(0)}
.ati{font-size:32px}
.att .atn{font-family:'Cinzel',serif;font-size:13px;font-weight:700;color:#7ec850}
.att .ats{font-size:11px;color:rgba(255,255,255,.7)}
#gbanner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:rgba(4,18,2,.96);border:3px solid #7ec850;border-radius:16px;padding:18px 40px;font-family:'Cinzel',serif;font-size:22px;font-weight:700;color:#7ec850;z-index:180;text-align:center;transition:transform .35s cubic-bezier(.34,1.56,.64,1);pointer-events:none;box-shadow:0 0 60px rgba(126,200,80,.45)}
#gbanner.show{transform:translate(-50%,-50%) scale(1)}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
#modal.hidden{display:none}
.parch{background:radial-gradient(ellipse at 22% 14%,rgba(200,240,180,.3)0%,transparent 54%),linear-gradient(160deg,#e8f5d8 0%,#c8e8a8 38%,#a8d070 72%,#88b840 100%);border:4px solid #4a8018;border-radius:18px;box-shadow:0 30px 90px rgba(0,0,0,.9);max-width:560px;width:96%;padding:28px 36px 24px;position:relative;animation:scUp .45s cubic-bezier(.34,1.56,.64,1);color:#1a3006}
@keyframes scUp{from{transform:scale(.65) translateY(40px);opacity:0}to{transform:scale(1);opacity:1}}
.pi{position:absolute;inset:10px;border:1px solid rgba(74,128,24,.22);border-radius:12px;pointer-events:none}
.pc{position:absolute;font-size:16px;color:#4a8018;opacity:.36}
.pc.tl{top:14px;left:18px}.pc.tr{top:14px;right:18px}.pc.bl{bottom:14px;left:18px}.pc.br{bottom:14px;right:18px}
.m-tier{font-family:'Cinzel',serif;font-size:10px;letter-spacing:5px;color:#2a5c08;text-align:center;text-transform:uppercase;margin-bottom:8px}
.m-gate-card{display:flex;align-items:center;gap:14px;margin-bottom:16px;padding:12px 18px;background:rgba(74,128,24,.13);border-radius:12px;border:2px solid rgba(74,128,24,.25)}
.m-gate-ico{font-size:42px;flex-shrink:0}
.m-gate-right{flex:1}
.m-gate-name{font-family:'Cinzel',serif;font-size:15px;font-weight:700;color:#2a5c08;letter-spacing:2px}
.m-gate-tool{display:flex;align-items:center;gap:6px;margin-top:5px;padding:5px 10px;background:rgba(74,128,24,.15);border:1px solid rgba(74,128,24,.35);border-radius:8px;font-size:12px;font-weight:700;color:#1a5808}
.m-gate-skipbtn{display:flex;align-items:center;gap:8px;width:100%;margin-bottom:14px;padding:10px 16px;background:linear-gradient(180deg,rgba(60,140,20,.85),rgba(30,90,10,.85));border:2px solid #7ec850;border-radius:11px;color:#d0f0a0;cursor:pointer;font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;transition:all .2s}
.m-gate-skipbtn:hover{background:linear-gradient(180deg,rgba(80,160,30,.9),rgba(40,110,15,.9));transform:scale(1.02)}
.m-gate-skipbtn .sb-ico{font-size:22px;flex-shrink:0}
.m-gate-skipbtn .sb-main{font-size:14px;font-weight:800;display:block}
.m-gate-skipbtn .sb-sub{font-size:11px;color:rgba(200,240,160,.7);display:block;margin-top:1px}
.m-sent{font-family:'Nunito',sans-serif;font-size:22px;font-weight:800;text-align:center;line-height:1.55;margin-bottom:6px}
.m-blank{display:inline-block;min-width:90px;border-bottom:3px solid #4a8018;text-align:center;color:#1a5808;padding:0 8px}
.m-basefm{font-size:13px;font-style:italic;color:#3a6010;text-align:center;margin-bottom:18px}
.m-opts{display:flex;flex-direction:column;gap:9px;margin-bottom:12px}
.m-opt{background:linear-gradient(180deg,rgba(255,255,255,.24)0%,rgba(255,255,255,.05)100%);border:2px solid rgba(74,128,24,.42);border-radius:11px;color:#1a3006;cursor:pointer;font-family:'Nunito',sans-serif;font-size:20px;font-weight:700;padding:12px 18px;text-align:left;transition:all .18s}
.m-opt .ol{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;background:#4a8018;color:#e8f5d8;border-radius:9px;font-family:'Cinzel',serif;font-size:13px;font-weight:700;margin-right:12px;flex-shrink:0}
.m-opt:hover:not(:disabled){background:rgba(200,240,150,.45);transform:translateX(6px);border-color:#4a8018}
.m-opt.ok{background:linear-gradient(180deg,#c8f5c0,#78d560);border-color:#3a8030!important}
.m-opt.bad{background:linear-gradient(180deg,#f5c0c0,#d06060);border-color:#903030!important;animation:shk .35s}
@keyframes shk{0%,100%{transform:translateX(0)}25%,75%{transform:translateX(-9px)}50%{transform:translateX(9px)}}
.m-fb{font-family:'Cinzel',serif;font-size:12px;font-weight:700;letter-spacing:2px;text-align:center;min-height:20px}
.m-fb.ok{color:#2a7020}.m-fb.bad{color:#8a2020}
.m-stats{display:flex;justify-content:center;gap:18px;margin-top:8px}
.m-stat{font-family:'Cinzel',serif;font-size:11px;color:#3a6010;display:flex;align-items:center;gap:4px}
#lvc{position:fixed;inset:0;background:rgba(0,0,0,.84);z-index:200;display:flex;align-items:center;justify-content:center}
#lvc.hidden{display:none}
.lcc{background:linear-gradient(150deg,#0a1e04,#051202);border:3px solid #7ec850;border-radius:20px;max-width:480px;width:95%;padding:38px;text-align:center;animation:zIn .6s cubic-bezier(.34,1.56,.64,1)}
@keyframes zIn{from{transform:scale(.65);opacity:0}to{transform:scale(1);opacity:1}}
.lc-ico{font-size:62px;animation:wb 3s ease-in-out infinite alternate}
@keyframes wb{from{transform:rotate(-6deg)}to{transform:rotate(6deg)}}
.lc-t{font-family:'Cinzel',serif;font-size:28px;font-weight:900;color:#7ec850;margin:10px 0 6px}
.lc-s{font-family:'Nunito',sans-serif;font-size:15px;color:#90c880;margin-bottom:22px}
.lc-sts{display:flex;justify-content:center;gap:22px;margin-bottom:22px;flex-wrap:wrap}
.lc-sv{font-family:'Cinzel',serif;font-size:24px;font-weight:700;color:#7ec850;display:block}
.lc-sl{font-family:'Nunito',sans-serif;font-size:10px;color:#5a7850;letter-spacing:2px;text-transform:uppercase}
.lc-ah{display:flex;flex-wrap:wrap;justify-content:center;gap:7px;margin-bottom:20px}
.ab{background:rgba(126,200,80,.14);border:1px solid rgba(126,200,80,.3);border-radius:8px;padding:4px 10px;font-size:11px;color:#7ec850;font-family:'Cinzel',serif}
#ge{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:300;display:flex;align-items:center;justify-content:center}
#ge.hidden{display:none}
.gec{background:linear-gradient(150deg,#e8f5d8,#c8e8a8 40%,#a0c870 100%);border:4px solid #4a8018;border-radius:20px;max-width:560px;width:95%;padding:42px;text-align:center;color:#1a3006;animation:zIn .6s cubic-bezier(.34,1.56,.64,1);position:relative}
.gei{position:absolute;inset:10px;border:1px solid rgba(74,128,24,.22);border-radius:14px;pointer-events:none}
.ge-ico{font-size:62px;animation:wb 4s ease-in-out infinite alternate}
.ge-pre{font-family:'Cinzel',serif;font-size:9px;letter-spacing:5px;color:#4a8018;text-transform:uppercase;margin-bottom:4px}
.ge-t{font-family:'Cinzel',serif;font-size:26px;font-weight:900;color:#1a3006;margin-bottom:14px}
.ge-sts{display:flex;justify-content:center;gap:22px;margin-bottom:20px;flex-wrap:wrap}
.ge-sv{font-family:'Cinzel',serif;font-size:24px;font-weight:700;color:#4a8018;display:block}
.ge-sl{font-family:'Nunito',sans-serif;font-size:10px;color:#3a6010;letter-spacing:2px;text-transform:uppercase}
.ge-ah{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:18px}
#ss{position:absolute;inset:0;z-index:200;background:radial-gradient(ellipse at 50% 30%,#1a6818,#040a02 100%);display:flex;align-items:center;justify-content:center}
#ss.hidden{display:none}
.ssc{background:rgba(4,14,2,.95);border:3px solid #7ec850;border-radius:22px;padding:40px 46px;text-align:center;max-width:520px;width:95%;box-shadow:0 0 90px rgba(126,200,80,.2)}
.ss-lo{font-size:60px;animation:bob 2.5s ease-in-out infinite}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.ss-sub{font-family:'Cinzel',serif;font-size:10px;letter-spacing:5px;color:#3a7018;text-transform:uppercase;margin-bottom:4px}
.ss-ti{font-family:'Cinzel',serif;font-size:clamp(24px,5vw,46px);font-weight:900;color:#7ec850;text-shadow:0 0 32px rgba(126,200,80,.5);line-height:1.1;margin-bottom:6px}
.ss-tg{font-family:'Nunito',sans-serif;font-size:16px;color:#6a9850;margin-bottom:10px}
.ss-de{font-family:'Nunito',sans-serif;font-size:13px;color:#3a5838;margin-bottom:24px;line-height:1.7}
.ss-de b{color:#7ec850}
.ss-lb{font-family:'Cinzel',serif;font-size:11px;letter-spacing:3px;color:#7ec850;text-transform:uppercase;display:block;margin-bottom:8px}
.ss-in{background:rgba(255,255,255,.05);border:2px solid #2a5810;border-radius:9px;color:#c8f0a0;font-family:'Nunito',sans-serif;font-size:18px;padding:11px 18px;text-align:center;outline:none;width:100%;margin-bottom:20px;transition:border-color .3s}
.ss-in:focus{border-color:#7ec850}
.bg{background:linear-gradient(180deg,#3a7010,#1a4808 60%,#0e3004 100%);border:2px solid #7ec850;border-radius:11px;color:#c8f080;cursor:pointer;font-family:'Cinzel',serif;font-size:15px;font-weight:700;letter-spacing:3px;padding:14px 42px;text-transform:uppercase;transition:all .25s}
.bg:hover{background:linear-gradient(180deg,#4a8820,#2a5810 60%,#1a4408 100%);transform:translateY(-2px)}
.ft{position:fixed;font-family:'Cinzel',serif;font-size:22px;font-weight:700;pointer-events:none;z-index:150;animation:ftu 1.3s ease forwards;text-shadow:0 2px 8px rgba(0,0,0,.9)}
@keyframes ftu{0%{transform:translateY(0) scale(1.2);opacity:1}100%{transform:translateY(-110px) scale(.8);opacity:0}}
.ft.ok{color:#4caf50}.ft.bad{color:#e53935}.ft.coin{color:#ffd54f}.ft.tool{color:#80cfff}
.cf{position:fixed;pointer-events:none;z-index:200;animation:cff linear forwards}
@keyframes cff{0%{opacity:1;transform:translateY(-10px) rotate(0)}100%{opacity:0;transform:translateY(110vh) rotate(720deg)}}
</style>
</head>
<body>
<div id="G">
<div id="ss">
<div class="ssc">
<div class="ss-lo">üåø</div>
<div class="ss-sub">Grammar Adventure RPG</div>
<div class="ss-ti">Maze of Verbs</div>
<div class="ss-tg">Hedge Garden ‚Äî Irregular Verbs Quest</div>
<div class="ss-de">
üß≠ Walk through the <b>round hedge maze</b> as an explorer<br>
üîí Gates <b>block corridors</b> ‚Äî answer grammar questions to pass<br>
üéØ Reach the <b>red X</b> in the center to win!<br>
‚û°Ô∏è <b>Yellow arrows</b> always show you the way!
</div>
<label class="ss-lb">Your Explorer's Name</label>
<input class="ss-in" id="nameIn" type="text" placeholder="Enter your name‚Ä¶" maxlength="22" autocomplete="off">
<button class="bg" id="startBtn">üåø Enter the Maze</button>
</div>
</div>
<canvas id="gc"></canvas>
<div id="hud">
<div class="av" title="Your hero">üß≠<div class="av-lv" id="avLv">1</div></div>
<div class="hstat">
<div class="hrow" data-tip="‚ù§Ô∏è HP ‚Äî Lives remaining">
<span class="hlabel">‚ù§Ô∏è HP</span>
<div class="hbar"><div class="hbar-fill hp" id="hpBar" style="width:100%"></div></div>
<span class="hval" id="hpVal">3/3</span>
</div>
<div class="hrow" data-tip="‚≠ê XP ‚Äî Experience points">
<span class="hlabel">‚≠ê XP</span>
<div class="hbar"><div class="hbar-fill xp" id="xpBar" style="width:0%"></div></div>
<span class="hval" id="xpVal">0/100</span>
</div>
</div>
<div class="hmid">
<div class="hlbl" id="progLbl">Level 1 ‚Äî Open all gates!</div>
<div class="hpbg"><div class="hpfg" id="progFg" style="width:0%"></div><div class="hptxt" id="progTxt">0/6 gates</div></div>
</div>
<div class="htimer" id="timer">00:00</div>
<div class="hcurs">
<div class="hcur g"><span>üíé</span><span id="gemC">5</span></div>
<div class="hcur c"><span>ü™ô</span><span id="coinC">100</span></div>
</div>
</div>
<div id="lvbadge">LEVEL <span id="lvNum">1</span></div>
<div id="mm"><canvas id="mmcv" width="108" height="108"></canvas></div>
<div id="qpanel">
<div class="qp-h">üìã Quest</div>
<div class="qp-r" id="qr1"><span class="qi">üîí</span><span id="qr1t">Open all gates</span></div>
<div class="qp-r" id="qr2"><span class="qi">‚ùå</span><span id="qr2t">Reach the red X center!</span></div>
</div>
<div id="toolpanel">
<div class="tp-title">TOOLS</div>
<div class="ts on" id="t0"><div class="ts-ico">üë£</div><div class="ts-nm">Walk</div>
<div class="ts-tooltip"><div class="tt-title">Walk Mode</div><div class="tt-works">Click anywhere to move</div><div class="tt-tip">Click a gate to answer</div></div>
</div>
<div class="ts" id="t1"><div class="ts-ico">ü™ì</div><div class="ts-nm">Axe</div><span class="ts-cnt" id="tc1">3</span>
<div class="ts-tooltip"><div class="tt-title">ü™ì Axe</div><div class="tt-works">Works on: üåø Vine Gates</div><div class="tt-tip">Chop through hedges!</div></div>
</div>
<div class="ts" id="t2"><div class="ts-ico">‚õèÔ∏è</div><div class="ts-nm">Pick</div><span class="ts-cnt" id="tc2">2</span>
<div class="ts-tooltip"><div class="tt-title">‚õèÔ∏è Pickaxe</div><div class="tt-works">Works on: ‚õ©Ô∏è Stone, üéã Bamboo</div><div class="tt-tip">Break stone barriers!</div></div>
</div>
<div class="ts" id="t3"><div class="ts-ico">üóùÔ∏è</div><div class="ts-nm">Key</div><span class="ts-cnt" id="tc3">1</span>
<div class="ts-tooltip"><div class="tt-title">üóùÔ∏è Magic Key</div><div class="tt-works">Works on: üîÆ Rune Doors</div><div class="tt-tip">Unlock magical gates!</div></div>
</div>
<div class="ts" id="t4"><div class="ts-ico">‚ú®</div><div class="ts-nm">Magic</div><span class="ts-cnt" id="tc4">1</span>
<div class="ts-tooltip"><div class="tt-title">‚ú® Magic Scroll</div><div class="tt-works">Works on: ALL gate types!</div><div class="tt-tip">Instant clear!</div></div>
</div>
</div>
<div id="bbar">
<button class="bb" id="hintBtn">üí° Hint (‚àí5ü™ô)</button>
<div id="bbhint">Click to walk ¬∑ Click gates to answer ¬∑ Find the red X!</div>
<button class="bb" id="pauseBtn">‚è∏ Pause</button>
</div>
<div id="spch"></div>
<div id="achtoast"><div class="ati" id="ati">üèÜ</div><div class="att"><div class="atn" id="atn">Achievement!</div><div class="ats" id="ats">Unlocked</div></div></div>
<div id="gbanner">üîì Gate Opened!</div>
<div id="wrongtool">
<span class="wt-ico" id="wt-ico">‚ùå</span>
<div class="wt-title" id="wt-title">Wrong Tool!</div>
<div class="wt-msg" id="wt-msg">That tool won't work here.</div>
<div class="wt-suggest" id="wt-suggest">Use ü™ì Axe instead!</div>
</div>
<div id="modal" class="hidden">
<div class="parch">
<div class="pi"></div>
<span class="pc tl">üåø</span><span class="pc tr">üå∫</span><span class="pc bl">üçÉ</span><span class="pc br">üå∏</span>
<div class="m-tier" id="mTier">Common Verbs ‚Äî Tier I</div>
<div class="m-gate-card">
<div class="m-gate-ico" id="mGIco">üåø</div>
<div class="m-gate-right">
<div class="m-gate-name" id="mGName">HEDGE GATE</div>
<div class="m-gate-tool"><span class="tool-ico" id="mToolIco">ü™ì</span><span id="mToolMsg">Or use Axe to skip</span></div>
</div>
</div>
<button class="m-gate-skipbtn hidden" id="mSkipBtn">
<span class="sb-ico" id="mSkipIco">ü™ì</span>
<span class="sb-txt"><span class="sb-main" id="mSkipMain">Use Axe to chop this gate!</span><span class="sb-sub" id="mSkipSub">3 uses remaining</span></span>
</button>
<div class="m-sent" id="mSent"></div>
<div class="m-basefm" id="mBase">Base form: "go"</div>
<div class="m-opts" id="mOpts"></div>
<div class="m-fb" id="mFb"></div>
<div class="m-stats">
<div class="m-stat">üéØ Streak: <span id="mStr">0</span></div>
<div class="m-stat">‚úÖ Accuracy: <span id="mAcc">‚Äî</span></div>
<div class="m-stat">ü™ô +10 on correct</div>
</div>
</div>
</div>
<div id="lvc" class="hidden">
<div class="lcc">
<div class="lc-ico">üéä</div>
<div class="lc-t" id="lcT">Maze Cleared!</div>
<div class="lc-s" id="lcS">You reached the center!</div>
<div class="lc-sts">
<div><span class="lc-sv" id="lcSc">0</span><span class="lc-sl">Score</span></div>
<div><span class="lc-sv" id="lcAc">100%</span><span class="lc-sl">Accuracy</span></div>
<div><span class="lc-sv" id="lcTm">0:00</span><span class="lc-sl">Time</span></div>
<div><span class="lc-sv" id="lcRw">+50ü™ô</span><span class="lc-sl">Reward</span></div>
</div>
<div class="lc-ah" id="lcAh"></div>
<button class="bg" id="nextBtn">Next Level ‚ñ∂</button>
</div>
</div>
<div id="ge" class="hidden">
<div class="gec"><div class="gei"></div>
<div class="ge-ico">üèÜ</div>
<div class="ge-pre">Certificate of Mastery</div>
<div class="ge-t" id="geT">Maze Champion!</div>
<div class="ge-sts">
<div><span class="ge-sv" id="geSc">0</span><span class="ge-sl">Score</span></div>
<div><span class="ge-sv" id="geAc">0%</span><span class="ge-sl">Accuracy</span></div>
<div><span class="ge-sv" id="geTm">0:00</span><span class="ge-sl">Time</span></div>
<div><span class="ge-sv" id="geLv">1</span><span class="ge-sl">Levels</span></div>
</div>
<div class="ge-ah" id="geAh"></div>
<button class="bg" id="replayBtn">üîÑ Play Again</button>
</div>
</div>
<script>
(()=>{
'use strict';
const VERBS=[
{b:'go',p:'went',d:['goed','gone'],t:1},{b:'take',p:'took',d:['taked','tooked'],t:1},
{b:'see',p:'saw',d:['seed','seen'],t:1},{b:'come',p:'came',d:['comed','come'],t:1},
{b:'get',p:'got',d:['getted','gotten'],t:1},{b:'make',p:'made',d:['maked','maed'],t:1},
{b:'know',p:'knew',d:['knowed','known'],t:1},{b:'think',p:'thought',d:['thinked','thunk'],t:1},
{b:'say',p:'said',d:['sayed','sed'],t:1},{b:'give',p:'gave',d:['gived','gaven'],t:1},
{b:'find',p:'found',d:['finded','founded'],t:1},{b:'tell',p:'told',d:['telled','tolded'],t:1},
{b:'write',p:'wrote',d:['writed','written'],t:2},{b:'break',p:'broke',d:['breaked','broked'],t:2},
{b:'speak',p:'spoke',d:['speaked','spoken'],t:2},{b:'drive',p:'drove',d:['drived','driven'],t:2},
{b:'choose',p:'chose',d:['choosed','chosen'],t:2},{b:'steal',p:'stole',d:['stealed','stolen'],t:2},
{b:'wear',p:'wore',d:['weared','worn'],t:2},{b:'forget',p:'forgot',d:['forgetted','forgotten'],t:2},
{b:'begin',p:'began',d:['beginned','begun'],t:2},{b:'swim',p:'swam',d:['swimmed','swum'],t:2},
{b:'seek',p:'sought',d:['seeked','sook'],t:3},{b:'flee',p:'fled',d:['fleed','flied'],t:3},
{b:'bind',p:'bound',d:['binded','bounden'],t:3},{b:'weave',p:'wove',d:['weaved','woven'],t:3},
{b:'slay',p:'slew',d:['slayed','slain'],t:3},{b:'awake',p:'awoke',d:['awaked','awaken'],t:3},
{b:'shine',p:'shone',d:['shined','shon'],t:3},{b:'deal',p:'dealt',d:['dealed','dealt'],t:3},
];
const SENTS=[
'Yesterday our explorer ______ through the hedge maze.',
'The ancient wizard ______ a powerful spell.',
'She bravely ______ the secret chamber.',
'He ______ through the dark green corridor.',
'They ______ the hidden passage at night.',
'The explorer ______ a strange artifact.',
'She ______ the answer to the ancient riddle.',
'He ______ deep into the garden labyrinth.',
'The guardian ______ into the shadows.',
'The brave knight ______ the path to the center.',
'She ______ about the danger and escaped.',
'Our guide ______ us through the maze.',
];
const TIER_LBL={1:'Common Verbs ‚Äî Tier I',2:'Intermediate ‚Äî Tier II',3:'Advanced ‚Äî Tier III'};
const GATE_DATA={
iron_gate:{nm:'STONE GATE',ic:'‚õ©Ô∏è',tool:'t2',toolIco:'‚õèÔ∏è',toolNm:'Pickaxe',msg:'Use ‚õèÔ∏è Pickaxe to smash it!'},
vine_gate:{nm:'HEDGE GATE',ic:'üåø',tool:'t1',toolIco:'ü™ì',toolNm:'Axe',msg:'Use ü™ì Axe to chop it!'},
rune_door:{nm:'RUNE DOOR',ic:'üîÆ',tool:'t3',toolIco:'üóùÔ∏è',toolNm:'Key',msg:'Use üóùÔ∏è Key to unlock!'},
spike_gate:{nm:'THORN WALL',ic:'üåµ',tool:'t2',toolIco:'‚õèÔ∏è',toolNm:'Pickaxe',msg:'Use ‚õèÔ∏è Pickaxe to break!'},
};
const TOOL_COMPAT={t1:['vine_gate'],t2:['iron_gate','spike_gate'],t3:['rune_door'],t4:['iron_gate','vine_gate','rune_door','spike_gate']};
const TOOL_ICO={t1:'ü™ì',t2:'‚õèÔ∏è',t3:'üóùÔ∏è',t4:'‚ú®'};
const WRONG_MSGS={
t1:{iron_gate:'ü™ì Axe can\'t break stone! Use ‚õèÔ∏è Pickaxe.',vine_gate:null,rune_door:'ü™ì Axe can\'t break runes! Use üóùÔ∏è Key.',spike_gate:'ü™ì Axe won\'t work! Use ‚õèÔ∏è Pickaxe.'},
t2:{iron_gate:null,vine_gate:'‚õèÔ∏è Pickaxe can\'t cut hedges! Use ü™ì Axe.',rune_door:'‚õèÔ∏è Pickaxe won\'t work on magic! Use üóùÔ∏è Key.',spike_gate:null},
t3:{iron_gate:'üóùÔ∏è Key can\'t open stone! Use ‚õèÔ∏è Pickaxe.',vine_gate:'üóùÔ∏è Key won\'t cut hedges! Use ü™ì Axe.',rune_door:null,spike_gate:'üóùÔ∏è Key can\'t break thorns! Use ‚õèÔ∏è Pickaxe.'},
};
const NPC_LINES=[
['Follow the yellow arrows!','The red X is in the center!','Open all gates first!'],
['Answer correctly ‚Äî gates open!','Use tools as shortcuts!','Watch the flashing gates!'],
['Woof! Follow me! üêï','*sniffs* This way!','Bark! Gate over there!'],
['Right tool = instant open!','Magic works on everything!','Need a key? Check tools!'],
];
const ACHS=[
{id:'a1',nm:'Gate Breaker',ds:'Open your first gate',ic:'üîì',fn:s=>s.cl>=1},
{id:'a2',nm:'Sharpshooter',ds:'5 correct answers in a row',ic:'üéØ',fn:s=>s.str>=5},
{id:'a3',nm:'Handyman',ds:'Use a tool on a gate',ic:'ü™ì',fn:s=>s.tu>=1},
{id:'a4',nm:'Trailblazer',ds:'Clear 10 gates total',ic:'üó∫Ô∏è',fn:s=>s.tc>=10},
{id:'a5',nm:'Scholar',ds:'20 correct answers',ic:'üìö',fn:s=>s.cor>=20},
{id:'a6',nm:'Pathfinder',ds:'Complete Level 1',ic:'üèÅ',fn:s=>s.lvc>=1},
{id:'a7',nm:'Untouchable',ds:'Level with no HP loss',ic:'üõ°Ô∏è',fn:s=>s.hloss===0},
{id:'a8',nm:'Speedster',ds:'Clear level under 90s',ic:'‚ö°',fn:s=>s.lt<90},
{id:'a9',nm:'Perfectionist',ds:'100% accuracy in a level',ic:'üíé',fn:s=>s.lacc>=100},
];
const CV=document.getElementById('gc');const CX=CV.getContext('2d');
const MC=document.getElementById('mmcv');const MX=MC.getContext('2d');
const COLS=19,ROWS=15;
const TW=100,TH=50,WH=72;
let W=0,H=0,OX=0,OY=0,SC=1;
let camX=0,camY=0,ctX=0,ctY=0;
const CX_MAZE=9,CY_MAZE=7;
let exitPos={col:CX_MAZE,row:CY_MAZE};
function resize(){
W=CV.width=window.innerWidth;H=CV.height=window.innerHeight;
const mW=(COLS+ROWS)*TW/2,mH=(COLS+ROWS)*TH/2+WH+20;
SC=Math.min(W*.60/mW,(H-66)*.63/mH,1.2);
OX=W/2;
OY=H*0.50-(CX_MAZE+CY_MAZE)*TH/2*SC;
}
function iso(c,r){return{x:OX+(c-r)*TW/2*SC-camX,y:OY+(c+r)*TH/2*SC-camY};}
function s2g(sx,sy){
const wx=sx+camX-OX,wy=sy+camY-OY;
return{col:Math.round((wx/(TW/2*SC)+wy/(TH/2*SC))/2),row:Math.round((wy/(TH/2*SC)-wx/(TW/2*SC))/2)};
}
let maze=[],gates=[],npcs=[],decors=[];
let verbQ=[],pPos={col:1,row:1};
let playerName='Explorer';
let score=0,hp=3,mhp=3,xp=0,lvl=1,coins=100,gems=5;
let totAns=0,corrAns=0,clrObs=0,totGates=6;
let active=false,inModal=false,paused=false;
let elapsed=0,timerID=null,curLvl=1,lastTs=0;
let facing=1,walkT=0;
let mPath=[],mTimer=0;const MDUR=0.16;
let curGate=null,curVerb=null;
let parts=[],gHits=[],nHits=[];
let opening=[];let arrowPath=[];const TOTAL_LVL=5;
let ST={cl:0,str:0,tu:0,tc:0,cor:0,lvc:0,hloss:0,lt:0,lacc:0};
let achDone=new Set();let lvlTs=0,lvlTot=0,lvlCorr=0;
const STOCK={t1:3,t2:2,t3:1,t4:1};
let curTool='t0';

function inCircle(c,r){
const dx=(c-CX_MAZE)/8.5,dy=(r-CY_MAZE)/6.2;
return dx*dx+dy*dy<=1.0;
}
function shuf(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=0|Math.random()*(i+1);[b[i],b[j]]=[b[j],b[i]];}return b;}
function buildMaze(){
maze=Array.from({length:ROWS},(_,r)=>Array.from({length:COLS},(_,c)=>inCircle(c,r)?1:2));
function carve(r,c){
maze[r][c]=0;
for(const[dr,dc]of shuf([[0,2],[0,-2],[2,0],[-2,0]])){
const nr=r+dr,nc=c+dc;
if(nr>=0&&nr<ROWS&&nc>=0&&nc<COLS&&inCircle(nc,nr)&&maze[nr][nc]===1){
maze[r+dr/2][c+dc/2]=0;
carve(nr,nc);
}
}
}
const startR=CY_MAZE,startC=1;
maze[startR][startC]=0;
carve(startR,startC);
for(let i=0;i<18;i++){
const r=1+Math.floor(Math.random()*(ROWS-2));
const c=1+Math.floor(Math.random()*(COLS-2));
if(inCircle(c,r))maze[r][c]=0;
}
for(let dr=-1;dr<=1;dr++)for(let dc=-1;dc<=1;dc++){
if(inCircle(CX_MAZE+dc,CY_MAZE+dr))maze[CY_MAZE+dr][CX_MAZE+dc]=0;
}
maze[CY_MAZE][1]=0;maze[CY_MAZE][2]=0;maze[CY_MAZE-1][1]=0;
pPos={col:1,row:CY_MAZE};
}
function openCells(excl=[]){
const out=[];
for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
if(maze[r][c]===0
&&!(r===CY_MAZE&&c<=2)
&&!(r===exitPos.row&&c===exitPos.col)
&&!excl.find(e=>e.row===r&&e.col===c))
out.push({row:r,col:c});
}
return out;
}
function bfs(sc,sr,ec,er,thru=false){
if(sc===ec&&sr===er)return[];
const key=(c,r)=>c+','+r,q=[{c:sc,r:sr,p:[]}],vis=new Set([key(sc,sr)]);
while(q.length){
const{c,r,p}=q.shift();
for(const[dc,dr]of[[0,-1],[0,1],[-1,0],[1,0]]){
const nc=c+dc,nr=r+dr;
if(nc<0||nr<0||nc>=COLS||nr>=ROWS||vis.has(key(nc,nr)))continue;
if(maze[nr][nc]===1||maze[nr][nc]===2)continue;
const gh=!thru&&gates.find(g=>g.col===nc&&g.row===nr&&!g.clr);
const np=[...p,{col:nc,row:nr}];
if(nc===ec&&nr===er)return np;
if(gh)continue;
vis.add(key(nc,nr));q.push({c:nc,r:nr,p:np});
}
}
return null;
}
function updArrows(){
const rem=gates.filter(g=>!g.clr);
if(!rem.length){arrowPath=bfs(pPos.col,pPos.row,exitPos.col,exitPos.row,true)||[];}
else{
let best=null,bd=9999;
rem.forEach(g=>{const d=Math.abs(g.col-pPos.col)+Math.abs(g.row-pPos.row);if(d<bd){bd=d;best=g;}});
arrowPath=best?bfs(pPos.col,pPos.row,best.col,best.row,true)||[]:[];
}
updQuest();
}
function updQuest(){
const rem=gates.filter(g=>!g.clr).length;
const r1=document.getElementById('qr1'),r2=document.getElementById('qr2');
const r1t=document.getElementById('qr1t'),r2t=document.getElementById('qr2t');
if(!rem){r1.className='qp-r done';r1t.textContent='All gates open! ‚úÖ';}
else{r1.className='qp-r';r1t.textContent=`Open ${rem} more gate${rem>1?'s':''}‚Ä¶`;}
if(!rem){r2.className='qp-r';r2t.textContent='‚Üí Go to red X center!';}
else{r2.className='qp-r';r2t.textContent='Exit locked until all gates open';}
}
function setupLevel(){
exitPos={col:CX_MAZE,row:CY_MAZE};
buildMaze();
const gcnt=Math.min(4+curLvl*2,12);totGates=gcnt;clrObs=0;
const cells=shuf(openCells());let used=[];
gates=[];
const gTypes=['iron_gate','vine_gate','rune_door','spike_gate'];
cells.slice(0,gcnt).forEach((p,i)=>{gates.push({...p,clr:false,type:gTypes[i%4],oa:0});used.push(p);});
npcs=[];
shuf(cells).filter(p=>!used.find(u=>u.row===p.row&&u.col===p.col)).slice(0,Math.min(2,curLvl)).forEach((p,i)=>{
npcs.push({...p,type:['old_man','child','dog','merchant'][i%4],ms:i%4});used.push(p);
});
decors=[];
const dT=['flower','mushroom','flower','rock','flower','mushroom'];
shuf(cells).filter(p=>!used.find(u=>u.row===p.row&&u.col===p.col)).slice(0,10+curLvl).forEach((p,i)=>{
decors.push({...p,type:dT[i%6]});
});
verbQ=shuf([...VERBS]);mPath=[];opening=[];
ST.hloss=0;ST.lacc=0;lvlTs=elapsed;lvlTot=0;lvlCorr=0;
updArrows();
}

// ‚úÖ –ò–°–ü–†–ê–í–õ–ï–ù–û: –£–¥–∞–ª—ë–Ω return; –≤ –Ω–∞—á–∞–ª–µ —Ñ—É–Ω–∫—Ü–∏–∏
function drawWall(c,r){
// return; ‚Üê –£–î–ê–õ–ï–ù–û!
const{x,y}=iso(c,r);
const hw=TW/2*SC,hh=TH/2*SC,wh=WH*SC;
const t=Date.now()/2000;
CX.save();
// Bottom faces
CX.beginPath();
CX.moveTo(x,y-hh);
CX.lineTo(x+hw,y);
CX.lineTo(x,y+hh);
CX.lineTo(x-hw,y);
CX.closePath();
const bf=CX.createLinearGradient(x,y-hh,x,y+hh);
bf.addColorStop(0,'#1a4a08');
bf.addColorStop(.5,'#0e3a04');
bf.addColorStop(1,'#0a2a02');
CX.fillStyle=bf;
CX.fill();
// Top hedge shape
CX.beginPath();
CX.moveTo(x,y-hh-wh);
CX.lineTo(x+hw,y-wh);
CX.lineTo(x,y+hh-wh);
CX.lineTo(x-hw,y-wh);
CX.closePath();
const tf=CX.createRadialGradient(x,y-wh-hh*.3,2,x,y-wh,hw*.9);
tf.addColorStop(0,'#a0e840');
tf.addColorStop(.25,'#80d828');
tf.addColorStop(.55,'#58c010');
tf.addColorStop(.8,'#3aaa08');
tf.addColorStop(1,'#268004');
CX.fillStyle=tf;
CX.fill();
CX.restore();
}

function drawFloor(c,r,tint){
if(!tint)return;
const{x,y}=iso(c,r);
const hw=TW/2*SC,hh=TH/2*SC;
CX.save();
CX.globalAlpha=0.35;
CX.beginPath();
CX.moveTo(x,y-hh);
CX.lineTo(x+hw,y);
CX.lineTo(x,y+hh);
CX.lineTo(x-hw,y);
CX.closePath();
CX.fillStyle=tint;
CX.fill();
CX.restore();
}

function drawGate(c,r,g,idx){
drawFloor(c,r);
const{x,y}=iso(c,r);
const s=SC;
const t=Date.now()/800,pulse=.5+.5*Math.sin(t+idx*1.5);
const oa=g.oa||0,al=1-oa;
const hw=TW/2*SC,gh=WH*SC*1.1;
const gd=GATE_DATA[g.type];
const ag=CX.createRadialGradient(x,y,4,x,y,30*s);
ag.addColorStop(0,`rgba(255,80,0,${(.3+.2*pulse)*al})`);
ag.addColorStop(1,'rgba(0,0,0,0)');
CX.fillStyle=ag;
CX.fillRect(x-35*s,y-35*s,70*s,70*s);
CX.save();
CX.globalAlpha=al;
if(g.type==='vine_gate'){
CX.fillStyle=`rgba(10,40,5,${.65*al})`;
CX.beginPath();
CX.moveTo(x-hw,y);
CX.lineTo(x,y-hh*s*.5);
CX.lineTo(x+hw,y);
CX.lineTo(x,y+hh*s*.5);
CX.closePath();
CX.fill();
for(let v=0;v<9;v++){
const vx=x-hw*.95+v*hw*1.9/8;
const vc=['#1a7005','#2a9010','#1e8008','#38a00e','#24900c'];
CX.strokeStyle=vc[v%5];
CX.lineWidth=(3+v%2)*s;
CX.lineCap='round';
CX.beginPath();
CX.moveTo(vx,y+4*s);
CX.bezierCurveTo(vx+8*s,y-gh*.25,vx-8*s,y-gh*.55,vx+5*s,y-gh*.92);
CX.stroke();
}
}
CX.restore();
const hh2=TH/2*SC;
gHits.push({c,r,g,cx:x,cy:y-WH*SC*.5,rad:34*s});
}

function drawExit(c,r){
const t=Date.now()/500,p=.5+.5*Math.sin(t);
const allDone=gates.every(g=>g.clr);
drawFloor(c,r,allDone?'rgba(90,230,70,.95)':'rgba(60,160,40,.85)');
const{x,y}=iso(c,r);
const s=SC;
if(allDone){
CX.save();
CX.shadowBlur=40*s;
CX.shadowColor='rgba(255,50,50,.9)';
CX.strokeStyle='rgba(255,60,60,.7)';
CX.lineWidth=4*s;
CX.beginPath();
CX.arc(x,y-14*s,18*s,0,Math.PI*2);
CX.stroke();
CX.restore();
}
const xSz=allDone?(14+4*p)*s:12*s;
const xThick=allDone?(5+1.5*p)*s:4*s;
CX.save();
if(allDone){
CX.shadowBlur=20*s;
CX.shadowColor='rgba(255,0,0,.8)';
}
CX.strokeStyle=allDone?`rgba(255,${30+Math.floor(30*p)},30,1)`:'rgba(200,30,30,.9)';
CX.lineWidth=xThick;
CX.lineCap='round';
CX.beginPath();
CX.moveTo(x-xSz,y-14*s-xSz);
CX.lineTo(x+xSz,y-14*s+xSz);
CX.stroke();
CX.beginPath();
CX.moveTo(x+xSz,y-14*s-xSz);
CX.lineTo(x-xSz,y-14*s+xSz);
CX.stroke();
CX.restore();
if(!allDone){
const rem=gates.filter(g=>!g.clr).length;
CX.save();
CX.font=`bold ${8*SC}px 'Cinzel',serif`;
CX.textAlign='center';
CX.fillStyle='rgba(255,255,255,.65)';
CX.fillText(`${rem} gates left`,x,y-30*s);
CX.restore();
}else{
CX.save();
CX.font=`${14*s}px serif`;
CX.textAlign='center';
CX.fillText('‚≠ê',x-16*s,y-30*s);
CX.fillText('‚≠ê',x+16*s,y-30*s);
CX.restore();
}
}

function drawDecor(c,r,type){
drawFloor(c,r);
const{x,y}=iso(c,r);
const s=SC;
CX.save();
if(type==='flower'){
CX.strokeStyle='#2a7010';
CX.lineWidth=2*s;
CX.beginPath();
CX.moveTo(x,y);
CX.lineTo(x,y-16*s);
CX.stroke();
const fc=['#ff6090','#ff9030','#60e0ff','#ff60c0','#ffee30','#ff80ff'];
CX.fillStyle=fc[(c*7+r*11)%6];
for(let a=0;a<6;a++){
const ang=a*Math.PI*2/6;
CX.beginPath();
CX.ellipse(x+Math.cos(ang)*5*s,y-16*s+Math.sin(ang)*5*s,4*s,2.5*s,ang,0,Math.PI*2);
CX.fill();
}
CX.fillStyle='#ffe262';
CX.beginPath();
CX.arc(x,y-16*s,3*s,0,Math.PI*2);
CX.fill();
}else if(type==='mushroom'){
CX.fillStyle='#e8d8a0';
CX.fillRect(x-3*s,y-11*s,6*s,11*s);
CX.fillStyle='#c83028';
CX.beginPath();
CX.arc(x,y-12*s,9*s,Math.PI,0);
CX.fill();
CX.fillStyle='rgba(255,255,255,.75)';
for(const dx of[-3.5,0,3.5]){
CX.beginPath();
CX.arc(x+dx*s,y-14*s,2*s,0,Math.PI*2);
CX.fill();
}
}else if(type==='rock'){
CX.fillStyle='#7a6a4a';
CX.beginPath();
CX.ellipse(x,y-6*s,10*s,7*s,0,0,Math.PI*2);
CX.fill();
CX.fillStyle='#9a8a60';
CX.beginPath();
CX.ellipse(x-2*s,y-8*s,7*s,5*s,.2,0,Math.PI*2);
CX.fill();
CX.fillStyle='rgba(60,150,15,.5)';
CX.beginPath();
CX.ellipse(x,y-11*s,5*s,2.5*s,0,0,Math.PI*2);
CX.fill();
}
CX.restore();
}

function drawArrows(){
if(!arrowPath.length)return;
arrowPath.slice(0,5).forEach((p,i)=>{
const{x,y}=iso(p.col,p.row);
const t2=Date.now()/500;
const a=.45+.3*Math.sin(t2+i*.8),sc2=.88+.12*Math.sin(t2+i*.8);
CX.save();
CX.globalAlpha=a*(1-i/5*.5);
CX.translate(x,y-WH*SC*.05);
CX.scale(sc2,sc2);
const as=13*SC;
CX.fillStyle='#f0e030';
CX.shadowBlur=10*SC;
CX.shadowColor='rgba(240,224,48,.8)';
CX.beginPath();
CX.moveTo(0,-as);
CX.lineTo(as*.6,-as*.2);
CX.lineTo(as*.3,-as*.2);
CX.lineTo(as*.3,as*.45);
CX.lineTo(-as*.3,as*.45);
CX.lineTo(-as*.3,-as*.2);
CX.lineTo(-as*.6,-as*.2);
CX.closePath();
CX.fill();
CX.restore();
});
}

function drawPathDots(){
if(!mPath.length)return;
CX.save();
mPath.forEach((p,i)=>{
const{x,y}=iso(p.col,p.row);
CX.globalAlpha=.5*(1-i/mPath.length);
CX.fillStyle='rgba(126,200,80,.9)';
CX.beginPath();
CX.arc(x,y+2*SC,3.5*SC,0,Math.PI*2);
CX.fill();
});
CX.restore();
}

function drawHero(x,y,flip,wt){
const s=SC;
CX.save();
CX.translate(x,y);
CX.scale(flip?1:-1,1);
// Legs
const lsw=Math.sin(wt*Math.PI*5)*16;
CX.fillStyle='#4a6a28';
CX.fillRect(-4.5*s,-26*s,9*s,20*s);
CX.strokeStyle='rgba(0,0,0,.2)';
CX.lineWidth=.8*s;
CX.strokeRect(-4*s,-22*s,6*s,6*s);
// Belt
CX.fillStyle='#6a3a10';
CX.fillRect(-11*s,-28*s,22*s,4*s);
CX.strokeStyle='#c89040';
CX.lineWidth=2*s;
CX.strokeRect(-3.5*s,-28*s,7*s,4*s);
// Bag
CX.fillStyle='#7a4a20';
CX.beginPath();
CX.roundRect(-flip*10*s,-30*s,12*s,14*s,3*s);
CX.fill();
// Torso
CX.fillStyle='#f0ede0';
CX.fillRect(-11*s,-52*s,22*s,26*s);
// Head
CX.fillStyle='#f0a870';
CX.beginPath();
CX.ellipse(0,-65*s,10*s,12*s,0,0,Math.PI*2);
CX.fill();
// Hat
CX.fillStyle='#5a8028';
CX.beginPath();
CX.ellipse(0,-71*s,10.5*s,6*s,0,0,Math.PI*2);
CX.fill();
CX.restore();
}

function drawNpcChar(x,y,flip,type){
const s=SC;
CX.save();
CX.translate(x,y);
CX.scale(flip?1:-1,1);
if(type==='dog'){
CX.fillStyle='#8a6a40';
CX.beginPath();
CX.ellipse(0,-14*s,10*s,8*s,0,0,Math.PI*2);
CX.fill();
CX.fillStyle='#1a0a04';
CX.beginPath();
CX.arc(11.5*s*flip,-14*s,1.8*s,0,Math.PI*2);
CX.fill();
}else{
const clr={old_man:'#708090',child:'#e04040',merchant:'#7a4a90'}[type]||'#3a7a3a';
CX.fillStyle=clr;
CX.fillRect(-9*s,-52*s,18*s,28*s);
CX.fillStyle='#f0a870';
CX.beginPath();
CX.ellipse(0,-65*s,10*s,12*s,0,0,Math.PI*2);
CX.fill();
}
CX.restore();
}

function drawNPC(c,r,npc){
const{x,y}=iso(c,r);
drawNpcChar(x,y,true,npc.type);
const s=SC;
nHits.push({npc,cx:x,cy:y-WH*SC*.5,rad:30*s});
}

function drawP(){
parts=parts.filter(p=>{
p.t+=.035;
if(p.t>1)return false;
CX.save();
CX.globalAlpha=(1-p.t)*.9;
CX.font=`${p.sz}px serif`;
CX.textAlign='center';
CX.textBaseline='middle';
CX.fillText(p.e,p.x+p.vx*p.t*60,p.y+p.vy*p.t*60-22*p.t*p.t*SC);
CX.restore();
return true;
});
}

function mkMinimap(){
const cw=108,ch=108,cs=Math.min(Math.floor(cw/COLS),Math.floor(ch/ROWS));
MX.clearRect(0,0,cw,ch);
MX.fillStyle='#020e02';
MX.fillRect(0,0,cw,ch);
for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
if(maze[r][c]===2){MX.fillStyle='transparent';continue;}
if(maze[r][c]===1)MX.fillStyle='#2a4a18';
else if(r===exitPos.row&&c===exitPos.col)MX.fillStyle='#ff3030';
else{
const g=gates.find(g=>g.row===r&&g.col===c&&!g.clr);
MX.fillStyle=g?'#ff5010':'#1e4010';
}
MX.fillRect(c*cs,r*cs,cs,cs);
}
arrowPath.slice(0,8).forEach(p=>{
MX.fillStyle='rgba(240,224,48,.55)';
MX.fillRect(p.col*cs,p.row*cs,cs,cs);
});
if(pPos&&pPos.col!==undefined&&pPos.row!==undefined){
MX.fillStyle='#f0e040';
MX.fillRect(pPos.col*cs-1,pPos.row*cs-1,cs+2,cs+2);
}
}

function lerp(a,b,t){return a+(b-a)*t;}

function updCam(){
const{x:px,y:py}=iso(pPos.col,pPos.row);
const cx=W/2,cy=(H-66)/2+66;
const dx=W*.22,dy=H*.18;
if(Math.abs(px-cx)>dx)ctX+=((px-cx)-(px>cx?dx:-dx))*.5;
if(Math.abs(py-cy)>dy)ctY+=((py-cy)-(py>cy?dy:-dy))*.5;
camX=lerp(camX,ctX,.1);
camY=lerp(camY,ctY,.1);
}

function stepMove(dt){
if(inModal||!mPath.length)return;
mTimer+=dt;
if(mTimer>=MDUR){
mTimer-=MDUR;
const nxt=mPath.shift();
if(!nxt)return;
const g=gates.find(g=>g.col===nxt.col&&g.row===nxt.row&&!g.clr);
if(g){
mPath=[];
mTimer=0;
curGate=g;
openChallenge();
return;
}
if(nxt.col===exitPos.col&&nxt.row===exitPos.row){
const rem=gates.filter(g=>!g.clr).length;
if(!rem){
pPos={...nxt};
mPath=[];
mTimer=0;
setTimeout(doLvlComplete,400);
return;
}else{
floatMsg(`Open ${rem} gate${rem>1?'s':''}!`,'bad');
mPath=[];
mTimer=0;
return;
}
}
if(nxt.col>pPos.col)facing=1;
else if(nxt.col<pPos.col)facing=-1;
pPos={...nxt};
walkT=(walkT+.15)%1;
updHUD();
mkMinimap();
updArrows();
}
}

function walkTo(tc,tr){
const path=bfs(pPos.col,pPos.row,tc,tr);
if(!path){floatMsg('No path!','bad');return;}
mPath=[...path];
mTimer=0;
}

function spawnP(x,y,ok){
for(let i=0;i<12;i++){
parts.push({
x,y,
e:ok?'‚ú®':'üíî',
vx:(Math.random()-.5)*.8,
vy:(Math.random()-.5)*.8,
sz:12+Math.random()*12*SC,
t:0
});
}
}

function floatMsg(text,cls){
const el=document.createElement('div');
el.className=`ft ${cls}`;
el.textContent=text;
el.style.left=(W/2-70)+'px';
el.style.top=(H/2-60)+'px';
document.body.appendChild(el);
setTimeout(()=>el.remove(),1400);
}

function confetti(){
const cs=['#7ec850','#4caf50','#2196f3','#ff9800','#e91e63','#fff','#ffeb3b'];
for(let i=0;i<90;i++)setTimeout(()=>{
const c=document.createElement('div');
c.className='cf';
c.style.cssText=`left:${Math.random()*100}vw;top:-8px;width:${5+Math.random()*9}px;height:${5+Math.random()*9}px;background:${cs[0|Math.random()*cs.length]};border-radius:${Math.random()>.5?'50%':'2px'};animation-duration:${2+Math.random()*2.5}s`;
document.body.appendChild(c);
setTimeout(()=>c.remove(),5e3);
},i*48);
}

function showRing(cx,cy){
const _rng=document.createElement('div');
_rng.style.cssText=`position:fixed;left:${cx-18}px;top:${cy-18}px;width:36px;height:36px;border-radius:50%;border:3px solid #7ec850;pointer-events:none;z-index:90;animation:rp .4s ease forwards`;
const st=document.createElement('style');
st.textContent='@keyframes rp{0%{transform:scale(.2);opacity:1}100%{transform:scale(1.8);opacity:0}}';
document.head.appendChild(st);
document.body.appendChild(_rng);
setTimeout(()=>{_rng&&_rng.remove();},450);
}

function setTool(t){
curTool=t;
document.querySelectorAll('.ts').forEach(el=>el.classList.remove('on'));
document.getElementById(t).classList.add('on');
}

function useTool(g,c,r){
const tid=curTool;
if(!TOOL_COMPAT[tid].includes(g.type)){
showWrongTool(tid,g.type);
return;
}
STOCK[tid]--;
document.getElementById('tc'+tid.slice(1)).textContent=STOCK[tid];
if(STOCK[tid]<=0)document.getElementById(tid).classList.add('dim');
setTool('t0');
openingAnim(g);
floatMsg(`${TOOL_ICO[tid]} Gate destroyed!`,'tool');
ST.tu++;
clrObs++;
ST.cl++;
ST.tc++;
setTimeout(()=>{
g.clr=true;
updHUD();
mkMinimap();
updArrows();
checkAchs();
},650);
}

function showWrongTool(tid,gtype){
const msgs=WRONG_MSGS[tid]||{};
const msg=msgs[gtype]||`Wrong tool for this gate!`;
const gd=GATE_DATA[gtype];
const wt=document.getElementById('wrongtool');
document.getElementById('wt-ico').textContent='üö´';
document.getElementById('wt-title').textContent='Wrong Tool!';
document.getElementById('wt-msg').textContent=msg;
document.getElementById('wt-suggest').textContent=`üëâ ${gd.toolIco} Use ${gd.toolNm} for ${gd.nm}`;
wt.classList.add('show');
setTimeout(()=>wt.classList.remove('show'),2800);
setTool('t0');
}

function openingAnim(g){
opening.push({g,t:0});
}

function updOpening(dt){
opening=opening.filter(o=>{
o.t+=dt*2.2;
if(o.t>=1)return false;
const{x,y}=iso(o.g.col,o.g.row);
const s=SC,al=1-o.t;
CX.save();
CX.globalAlpha=al*.7;
CX.fillStyle='#7ec850';
for(let i=0;i<8;i++){
const ang=i*Math.PI*2/8;
const dist=(15+o.t*40)*s;
CX.beginPath();
CX.arc(x+Math.cos(ang)*dist,y-WH*SC*.5+Math.sin(ang)*dist,4*s*(1-o.t),0,Math.PI*2);
CX.fill();
}
CX.restore();
return true;
});
}

function showGateBanner(){
const msgs=['üîì Gate Opened!','üåø Hedge Cut!','üåü Excellent!','‚úÖ Gate Open!','üéØ Perfect!'];
const b=document.getElementById('gbanner');
b.textContent=msgs[Math.floor(Math.random()*msgs.length)];
b.classList.add('show');
setTimeout(()=>b.classList.remove('show'),1600);
}

function checkAchs(){
ACHS.forEach(a=>{
if(!achDone.has(a.id)&&a.fn(ST)){
achDone.add(a.id);
showAch(a);
}
});
}

function showAch(a){
document.getElementById('ati').textContent=a.ic;
document.getElementById('atn').textContent=a.nm;
document.getElementById('ats').textContent=a.ds;
const el=document.getElementById('achtoast');
el.classList.add('show');
setTimeout(()=>el.classList.remove('show'),3200);
}

function doLvlComplete(){
active=false;
ST.lt=elapsed-lvlTs;
if(lvlTot>0)ST.lacc=Math.round(lvlCorr/lvlTot*100);
ST.lvc++;
const acc=totAns>0?Math.round(corrAns/totAns*100):100;
const rwd=40+curLvl*12;
coins+=rwd;
gems+=2+Math.floor(curLvl/2);
document.getElementById('lcT').textContent=curLvl>=TOTAL_LVL?'All Mazes Cleared! üèÜ':'Maze Cleared!';
document.getElementById('lcS').textContent=curLvl>=TOTAL_LVL?'You conquered all the hedges!':'A bigger maze awaits‚Ä¶';
document.getElementById('lcSc').textContent=score;
document.getElementById('lcAc').textContent=acc+'%';
document.getElementById('lcTm').textContent=fmtT(elapsed);
document.getElementById('lcRw').textContent=`+${rwd}ü™ô`;
document.getElementById('lcAh').innerHTML=[...achDone].slice(-4).map(id=>{
const a=ACHS.find(a=>a.id===id);
return a?`<span class="ab">${a.ic} ${a.nm}</span>`:'';
}).join('');
document.getElementById('lvc').classList.remove('hidden');
confetti();
checkAchs();
}

function doGameEnd(won){
active=false;
if(timerID){clearInterval(timerID);timerID=null;}
const acc=totAns>0?Math.round(corrAns/totAns*100):100;
document.getElementById('geT').textContent=won?`${playerName} ‚Äî Hedge Champion!`:`${playerName} ‚Äî Lost in the Maze‚Ä¶`;
document.getElementById('geSc').textContent=score;
document.getElementById('geAc').textContent=acc+'%';
document.getElementById('geTm').textContent=fmtT(elapsed);
document.getElementById('geLv').textContent=curLvl;
document.getElementById('geAh').innerHTML=[...achDone].map(id=>{
const a=ACHS.find(a=>a.id===id);
return a?`<span class="ab">${a.ic} ${a.nm}</span>`:'';
}).join('');
document.getElementById('ge').classList.remove('hidden');
if(won)confetti();
}

function updHUD(){
document.getElementById('hpBar').style.width=(hp/mhp*100)+'%';
document.getElementById('hpVal').textContent=`${hp}/${mhp}`;
document.getElementById('xpBar').style.width=(xp)+'%';
document.getElementById('xpVal').textContent=`${xp}/100`;
document.getElementById('avLv').textContent=lvl;
document.getElementById('lvNum').textContent=curLvl;
document.getElementById('coinC').textContent=coins;
document.getElementById('gemC').textContent=gems;
const pct=totGates>0?Math.round(clrObs/totGates*100):0;
document.getElementById('progFg').style.width=pct+'%';
document.getElementById('progTxt').textContent=`${clrObs}/${totGates} gates`;
document.getElementById('progLbl').textContent=`Level ${curLvl} ‚Äî ${clrObs>=totGates?'Find the red X!':'Open all gates!'}`;
Object.keys(STOCK).forEach(k=>{
document.getElementById('tc'+k.slice(1)).textContent=STOCK[k];
document.getElementById(k).classList.toggle('dim',STOCK[k]<=0);
});
}

function fmtT(s){
const m=Math.floor(s/60);
return`${String(m).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;
}

function openChallenge(){
inModal=true;
curVerb=verbQ.shift();
if(!curVerb)verbQ=shuf([...VERBS]),curVerb=verbQ.shift();
const gd=GATE_DATA[curGate.type];
const tid=gd.tool;
const stock=STOCK[tid]||0;
document.getElementById('mTier').textContent=TIER_LBL[curVerb.t]||'Common Verbs';
document.getElementById('mGIco').textContent=gd.ic;
document.getElementById('mGName').textContent=gd.nm;
document.getElementById('mToolIco').textContent=gd.toolIco;
document.getElementById('mToolMsg').textContent=stock>0?`Or use ${gd.toolNm} to skip (${stock} left)`:`No ${gd.toolNm} left ‚Äî answer to pass!`;
const skipBtn=document.getElementById('mSkipBtn');
if(stock>0){
skipBtn.classList.remove('hidden');
document.getElementById('mSkipIco').textContent=gd.toolIco;
document.getElementById('mSkipMain').textContent=`Use ${gd.toolNm} to destroy this gate!`;
document.getElementById('mSkipSub').textContent=`${stock} use${stock>1?'s':''} remaining`;
}else{
skipBtn.classList.add('hidden');
}
const sent=SENTS[Math.floor(Math.random()*SENTS.length)];
document.getElementById('mSent').innerHTML=sent.replace('______',`<span class="m-blank">______</span>`);
document.getElementById('mBase').textContent=`Base form: "${curVerb.b}"`;
const opts=shuf([{t:curVerb.p,ok:true},{t:curVerb.d[0],ok:false},{t:curVerb.d[1],ok:false}]);
const oc=document.getElementById('mOpts');
oc.innerHTML='';
opts.forEach((opt,i)=>{
const l=['A','B','C'][i];
const b=document.createElement('button');
b.className='m-opt';
b.innerHTML=`<span class="ol">${l}</span>${opt.t}`;
b.addEventListener('click',()=>answer(opt,b));
oc.appendChild(b);
});
document.getElementById('mFb').textContent='';
document.getElementById('mStr').textContent=ST.str;
document.getElementById('mAcc').textContent=totAns>0?Math.round(corrAns/totAns*100)+'%':'‚Äî';
document.getElementById('modal').classList.remove('hidden');
}

function answer(opt,btn){
document.querySelectorAll('.m-opt').forEach(b=>b.disabled=true);
totAns++;
lvlTot++;
const{x:px,y:py}=iso(pPos.col,pPos.row);
if(opt.ok){
corrAns++;
lvlCorr++;
score+=5;
xp=Math.min(xp+15,100);
coins+=10;
clrObs++;
ST.cl++;
ST.tc++;
ST.cor++;
ST.str++;
btn.classList.add('ok');
document.getElementById('mFb').textContent=`‚úÖ "${curVerb.b}" ‚Üí "${curVerb.p}" Excellent!`;
document.getElementById('mFb').className='m-fb ok';
floatMsg(`‚úÖ +5pts +10ü™ô`,'ok');
spawnP(px,py,true);
setTimeout(()=>{
document.getElementById('modal').classList.add('hidden');
inModal=false;
if(curGate){
openingAnim(curGate);
showGateBanner();
}
setTimeout(()=>{
if(curGate){
curGate.clr=true;
curGate=null;
}
updHUD();
mkMinimap();
updArrows();
checkAchs();
},650);
},900);
}else{
hp=Math.max(0,hp-1);
score=Math.max(0,score-3);
ST.str=0;
ST.hloss++;
btn.classList.add('bad');
document.querySelectorAll('.m-opt').forEach(b=>{
if(!b.disabled&&b.innerHTML.includes(curVerb.p))b.classList.add('ok');
});
document.getElementById('mFb').textContent=`‚ùå Correct: "${curVerb.p}"`;
document.getElementById('mFb').className='m-fb bad';
floatMsg(`‚ùå Wrong! ‚àí3pts`,'bad');
spawnP(px,py,false);
updHUD();
if(hp<=0){
setTimeout(()=>{
document.getElementById('modal').classList.add('hidden');
inModal=false;
doGameEnd(false);
},1400);
return;
}
setTimeout(()=>{
document.getElementById('modal').classList.add('hidden');
inModal=false;
curGate=null;
updArrows();
},1500);
}
}

function init(){
score=0;
hp=mhp;
xp=0;
lvl=1;
coins=100;
gems=5;
totAns=0;
corrAns=0;
clrObs=0;
curLvl=1;
parts=[];
curGate=null;
curVerb=null;
exitPos={col:CX_MAZE,row:CY_MAZE};
pPos={col:1,row:CY_MAZE};
facing=1;
walkT=0;
mPath=[];
mTimer=0;
opening=[];
inModal=false;
active=false;
camX=camY=ctX=ctY=0;
ST={cl:0,str:0,tu:0,tc:0,cor:0,lvc:0,hloss:0,lt:0,lacc:0};
achDone=new Set();
lvlTs=0;
lvlTot=0;
lvlCorr=0;
Object.keys(STOCK).forEach(k=>STOCK[k]={t1:3,t2:2,t3:1,t4:1}[k]);
curTool='t0';
if(timerID){clearInterval(timerID);timerID=null;}
elapsed=0;
timerID=setInterval(()=>{if(active&&!paused)elapsed++;updTimer();},1000);
}

function updTimer(){
document.getElementById('timer').textContent=fmtT(elapsed);
}

function drawBg(){
CX.fillStyle='#0a1a04';
CX.fillRect(0,0,W,H);
}

function render(ts){
requestAnimationFrame(render);
if(!document.getElementById('ss').classList.contains('hidden'))return;
const dt=Math.min((ts-lastTs)/1000,.05);
lastTs=ts;
if(active&&!paused){
stepMove(dt);
updCam();
updOpening(dt);
}
CX.clearRect(0,0,W,H);
drawBg();
gHits=[];
nHits=[];
for(let r=0;r<ROWS;r++){
for(let c=0;c<COLS;c++){
if(maze[r][c]===2)continue;
if(maze[r][c]===1){
drawWall(c,r);
}else{
const g=gates.find(g=>g.row===r&&g.col===c&&!g.clr);
const npc=npcs.find(n=>n.row===r&&n.col===c);
const dec=decors.find(d=>d.row===r&&d.col===c);
if(r===exitPos.row&&c===exitPos.col)drawExit(c,r);
else if(g)drawGate(c,r,g,gates.indexOf(g));
else if(dec)drawDecor(c,r,dec.type);
else drawFloor(c,r);
if(npc)drawNPC(c,r,npc);
}
}
}
drawArrows();
drawPathDots();
const doff=facing===1?-1:1,dc2=Math.max(0,Math.min(COLS-1,pPos.col+doff));
if(pPos.row<ROWS&&maze[pPos.row]&&maze[pPos.row][dc2]===0){
const{x:dx2,y:dy2}=iso(dc2,pPos.row);
drawNpcChar(dx2,dy2,facing===1,'dog');
}
const{x:px,y:py}=iso(pPos.col,pPos.row);
drawHero(px,py,facing===1,walkT);
drawP();
}

CV.addEventListener('click',e=>{
if(!active||inModal)return;
const rect=CV.getBoundingClientRect();
const mx=(e.clientX-rect.left)*(CV.width/rect.width),my=(e.clientY-rect.top)*(CV.height/rect.height);
showRing(e.clientX,e.clientY);
for(const a of gHits){
const dx=mx-a.cx,dy=my-a.cy;
if(dx*dx+dy*dy<a.rad*a.rad){
const dist=Math.abs(a.c-pPos.col)+Math.abs(a.r-pPos.row);
if(curTool!=='t0'){
useTool(a.g,a.c,a.r);
return;
}
if(dist<=3){
curGate=a.g;
mPath=[];
openChallenge();
}else walkTo(a.c,a.r);
return;
}
}
for(const a of nHits){
const dx=mx-a.cx,dy=my-a.cy;
if(dx*dx+dy*dy<a.rad*a.rad){
talkNPC(a.npc,a.cx,a.cy);
return;
}
}
const{col,row}=s2g(mx,my);
if(col<0||row<0||col>=COLS||row>=ROWS)return;
if(maze[row][col]===1||maze[row][col]===2)return;
walkTo(col,row);
});

document.addEventListener('keydown',e=>{
if(!active||inModal)return;
const m={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1],w:[-1,0],s:[1,0],a:[0,-1],d:[0,1]};
const[dr,dc]=m[e.key]||[];
if(dr===undefined)return;
e.preventDefault();
walkTo(pPos.col+dc,pPos.row+dr);
});

document.querySelectorAll('.ts').forEach(el=>{
el.addEventListener('click',()=>{
const id=el.id;
if(el.classList.contains('dim'))return;
setTool(id);
const hints={t0:'üë£ Click to walk',t1:'ü™ì Works on vine gates',t2:'‚õèÔ∏è Works on stone gates',t3:'üóùÔ∏è Works on rune doors',t4:'‚ú® Works on ALL gates!'};
document.getElementById('bbhint').textContent=hints[id]||'';
});
});

document.getElementById('startBtn').addEventListener('click',()=>{
const name=document.getElementById('nameIn').value.trim()||'Explorer';
playerName=name;
document.getElementById('ss').classList.add('hidden');
init();
setupLevel();
updHUD();
mkMinimap();
active=true;
lastTs=performance.now();
render(lastTs);
});

document.getElementById('nextBtn').addEventListener('click',()=>{
document.getElementById('lvc').classList.add('hidden');
if(curLvl>=TOTAL_LVL){
doGameEnd(true);
return;
}
curLvl++;
pPos={col:1,row:CY_MAZE};
camX=camY=ctX=ctY=0;
mPath=[];
mTimer=0;
opening=[];
setupLevel();
updHUD();
mkMinimap();
active=true;
});

document.getElementById('replayBtn').addEventListener('click',()=>{
document.getElementById('ge').classList.add('hidden');
document.getElementById('ss').classList.remove('hidden');
});

document.getElementById('pauseBtn').addEventListener('click',()=>{
active=!active;
document.getElementById('pauseBtn').textContent=active?'‚è∏ Pause':'‚ñ∂ Resume';
});

document.getElementById('hintBtn').addEventListener('click',()=>{
if(coins<5)return;
coins-=5;
const hints=['Look for the closest gate!','Use the right tool!','Yellow arrows show the way!','Answer grammar to open gates!'];
floatMsg(hints[Math.floor(Math.random()*hints.length)],'coin');
updHUD();
});

window.addEventListener('resize',resize);
resize();
})();
</script>
</div>
</body>
</html>
