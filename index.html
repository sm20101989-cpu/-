<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no">
<title>Maze of Verbs ‚Äî Jungle</title>
<link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700;900&family=Nunito:wght@600;700;800;900&display=swap" rel="stylesheet">
<style>
*{box-sizing:border-box;margin:0;padding:0}
html,body{width:100%;height:100%;overflow:hidden;background:#0a1a04;font-family:'Nunito',sans-serif;user-select:none;-webkit-user-select:none}
#G{position:relative;width:100%;height:100%}
canvas{display:block;position:absolute;inset:0;width:100%;height:100%;cursor:pointer}
#hud{position:absolute;top:0;left:0;right:0;height:66px;display:flex;align-items:center;gap:8px;padding:6px 12px;z-index:50;pointer-events:none;background:linear-gradient(180deg,rgba(0,20,0,.8)0%,transparent)}
.av{width:54px;height:54px;border:3px solid #7ec850;border-radius:50%;background:radial-gradient(#2a5a10,#0a1e04);display:flex;align-items:center;justify-content:center;font-size:26px;box-shadow:0 0 16px rgba(126,200,80,.5);flex-shrink:0;position:relative;pointer-events:all;cursor:pointer}
.av-lv{position:absolute;bottom:-3px;right:-3px;background:#7ec850;color:#0a1e04;font-family:'Cinzel',serif;font-size:9px;font-weight:900;border-radius:7px;padding:1px 5px}
.hstat{display:flex;flex-direction:column;gap:4px;flex-shrink:0}
.hrow{display:flex;align-items:center;gap:5px;position:relative}
.hrow .hlabel{font-family:'Cinzel',serif;font-size:8px;letter-spacing:.5px;color:rgba(255,255,255,.55);text-transform:uppercase;min-width:28px;flex-shrink:0}
.hbar{width:90px;height:12px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);border-radius:6px;overflow:hidden;flex-shrink:0}
.hbar-fill{height:100%;border-radius:6px;transition:width .4s}
.hbar-fill.hp{background:linear-gradient(90deg,#c62828,#f44336,#ff8a65)}
.hbar-fill.xp{background:linear-gradient(90deg,#2e7d32,#4caf50,#a5d6a7)}
.hval{font-size:11px;color:rgba(255,255,255,.85);font-weight:700;min-width:32px;font-family:'Cinzel',serif}
.hrow[data-tip]{cursor:help;pointer-events:all}
.hrow[data-tip]:hover::after{content:attr(data-tip);position:absolute;top:calc(100% + 6px);left:0;background:rgba(5,15,2,.97);border:1px solid rgba(126,200,80,.5);border-radius:8px;padding:6px 12px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#7ec850;white-space:nowrap;z-index:200;pointer-events:none;box-shadow:0 4px 14px rgba(0,0,0,.8)}
.hmid{flex:1;display:flex;flex-direction:column;gap:3px;min-width:0}
.hlbl{font-family:'Cinzel',serif;font-size:8px;letter-spacing:2px;color:#7ec850;text-transform:uppercase;text-shadow:0 1px 3px rgba(0,0,0,.9)}
.hpbg{width:100%;height:14px;background:rgba(0,0,0,.45);border:1px solid rgba(255,255,255,.12);border-radius:8px;overflow:hidden;position:relative}
.hpfg{height:100%;background:linear-gradient(90deg,#2e7d32,#66bb6a,#a5d6a7);border-radius:8px;transition:width .7s cubic-bezier(.34,1.56,.64,1)}
.hptxt{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;font-family:'Cinzel',serif;font-size:10px;font-weight:700;color:#fff;text-shadow:0 1px 3px rgba(0,0,0,.9)}
.htimer{font-family:'Cinzel',serif;font-size:15px;font-weight:700;color:#a8e060;background:rgba(0,0,0,.5);border:1px solid rgba(126,200,80,.3);border-radius:8px;padding:4px 10px;letter-spacing:1px;flex-shrink:0;pointer-events:all;cursor:help;position:relative}
.htimer[data-tip]:hover::after{content:attr(data-tip);position:absolute;top:calc(100% + 6px);right:0;background:rgba(5,15,2,.97);border:1px solid rgba(126,200,80,.5);border-radius:8px;padding:6px 12px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#7ec850;white-space:nowrap;z-index:200}
.hcurs{display:flex;gap:6px;flex-shrink:0}
.hcur{display:flex;align-items:center;gap:4px;background:rgba(0,0,0,.55);border:2px solid rgba(255,255,255,.12);border-radius:20px;padding:4px 10px;font-family:'Cinzel',serif;font-weight:700;font-size:12px;pointer-events:all;cursor:help;position:relative}
.hcur.c{color:#ffd54f;border-color:rgba(255,213,79,.3)}
.hcur.g{color:#e879f9;border-color:rgba(232,121,249,.3)}
.hcur[data-tip]:hover::after{content:attr(data-tip);position:absolute;top:calc(100%+6px);right:0;background:rgba(5,15,2,.97);border:1px solid rgba(126,200,80,.5);border-radius:8px;padding:6px 12px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#7ec850;white-space:nowrap;z-index:200;pointer-events:none;margin-top:6px}
#toolpanel{position:absolute;right:10px;top:50%;transform:translateY(-50%);display:flex;flex-direction:column;gap:7px;z-index:50;background:rgba(4,18,2,.9);border:2px solid rgba(126,200,80,.32);border-radius:18px;padding:10px 7px;box-shadow:0 4px 24px rgba(0,0,0,.7)}
.tp-title{font-family:'Cinzel',serif;font-size:8px;letter-spacing:2px;color:rgba(126,200,80,.55);text-transform:uppercase;text-align:center;margin-bottom:3px}
.ts{width:58px;height:58px;border-radius:14px;background:rgba(255,255,255,.06);border:2px solid rgba(255,255,255,.1);display:flex;flex-direction:column;align-items:center;justify-content:center;cursor:pointer;transition:all .18s;position:relative}
.ts:hover{background:rgba(126,200,80,.16);border-color:rgba(126,200,80,.5);transform:scale(1.06)}
.ts.on{background:rgba(126,200,80,.24);border-color:#7ec850;box-shadow:0 0 18px rgba(126,200,80,.5)}
.ts.dim{opacity:.28;cursor:not-allowed;pointer-events:none}
.ts-ico{font-size:24px;line-height:1}
.ts-nm{font-size:7px;font-weight:800;color:rgba(255,255,255,.58);text-transform:uppercase;margin-top:2px}
.ts-cnt{position:absolute;top:-5px;right:-5px;background:#7ec850;color:#0a1e04;font-size:10px;font-weight:900;border-radius:10px;padding:0 5px;font-family:'Cinzel',serif;min-width:18px;text-align:center;box-shadow:0 2px 6px rgba(0,0,0,.5)}
.ts-tooltip{position:absolute;right:calc(100% + 14px);top:50%;transform:translateY(-50%);background:rgba(4,18,2,.97);border:2px solid rgba(126,200,80,.45);border-radius:10px;padding:8px 12px;font-family:'Nunito',sans-serif;font-size:12px;font-weight:700;color:#fff;white-space:nowrap;pointer-events:none;opacity:0;transition:opacity .18s;z-index:100;box-shadow:0 4px 18px rgba(0,0,0,.8);min-width:180px}
.ts-tooltip .tt-title{font-family:'Cinzel',serif;font-size:11px;font-weight:700;color:#7ec850;margin-bottom:4px}
.ts-tooltip .tt-works{font-size:11px;color:rgba(255,255,255,.75)}
.ts-tooltip .tt-tip{font-size:10px;color:rgba(180,255,180,.8);margin-top:3px;font-style:italic}
.ts:hover .ts-tooltip{opacity:1}
#mm{position:absolute;top:72px;left:10px;width:108px;height:108px;background:rgba(4,18,2,.9);border:2px solid rgba(126,200,80,.35);border-radius:10px;z-index:45;overflow:hidden}
#mmcv{width:100%;height:100%}
#lvbadge{position:absolute;top:72px;left:126px;background:rgba(4,18,2,.9);border:2px solid rgba(126,200,80,.4);border-radius:8px;padding:4px 12px;font-family:'Cinzel',serif;font-size:10px;font-weight:700;color:#7ec850;z-index:45;letter-spacing:2px}
#qpanel{position:absolute;bottom:66px;left:10px;background:rgba(4,18,2,.92);border:2px solid rgba(126,200,80,.32);border-radius:12px;padding:10px 14px;z-index:45;max-width:210px}
.qp-h{font-family:'Cinzel',serif;font-size:9px;letter-spacing:3px;color:#7ec850;text-transform:uppercase;margin-bottom:6px}
.qp-r{display:flex;align-items:center;gap:8px;margin-bottom:4px;font-size:12px;font-weight:700;color:rgba(255,255,255,.82);line-height:1.3}
.qp-r.done{color:rgba(90,200,70,.8)}
.qp-r .qi{font-size:15px;flex-shrink:0}
#wrongtool{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:rgba(8,2,2,.97);border:3px solid #e53935;border-radius:16px;padding:18px 32px;z-index:190;text-align:center;pointer-events:none;transition:transform .3s cubic-bezier(.34,1.56,.64,1);box-shadow:0 0 50px rgba(229,57,53,.4);max-width:380px;width:90%}
#wrongtool.show{transform:translate(-50%,-50%) scale(1)}
#wrongtool .wt-ico{font-size:38px;display:block;margin-bottom:6px}
#wrongtool .wt-title{font-family:'Cinzel',serif;font-size:17px;font-weight:700;color:#ff5252;margin-bottom:6px;letter-spacing:1px}
#wrongtool .wt-msg{font-family:'Nunito',sans-serif;font-size:14px;color:rgba(255,200,200,.85);line-height:1.5}
#wrongtool .wt-suggest{font-family:'Cinzel',serif;font-size:13px;color:#7ec850;margin-top:8px;padding:6px 12px;background:rgba(126,200,80,.12);border-radius:8px;border:1px solid rgba(126,200,80,.3)}
#bbar{position:absolute;bottom:0;left:0;right:0;height:60px;display:flex;align-items:center;justify-content:space-between;padding:0 12px;z-index:50;background:linear-gradient(0deg,rgba(0,10,0,.68)0%,transparent)}
.bb{background:rgba(4,14,2,.88);border:2px solid rgba(126,200,80,.3);border-radius:9px;color:#7ec850;font-family:'Cinzel',serif;font-size:10px;letter-spacing:1px;padding:8px 14px;cursor:pointer;transition:all .2s;text-transform:uppercase;font-weight:700;pointer-events:all}
.bb:hover{border-color:#7ec850;box-shadow:0 0 10px rgba(126,200,80,.3)}
#bbhint{font-family:'Cinzel',serif;font-size:8px;letter-spacing:1px;color:rgba(126,200,80,.45);text-align:center;flex:1;text-transform:uppercase}
#spch{position:absolute;background:rgba(255,252,240,.97);border:3px solid #7ec850;border-radius:14px;padding:10px 13px;font-size:13px;font-weight:700;color:#1a3a06;max-width:185px;z-index:55;box-shadow:0 4px 16px rgba(0,0,0,.5);display:none;pointer-events:none;line-height:1.4}
#spch::after{content:'';position:absolute;bottom:-11px;left:18px;border-left:10px solid transparent;border-right:10px solid transparent;border-top:11px solid #7ec850}
#achtoast{position:fixed;top:72px;left:50%;transform:translateX(-50%) translateY(-130px);background:linear-gradient(135deg,rgba(4,18,2,.97),rgba(10,30,4,.97));border:2px solid #7ec850;border-radius:14px;padding:12px 22px;z-index:200;display:flex;align-items:center;gap:12px;box-shadow:0 6px 30px rgba(126,200,80,.3);transition:transform .5s cubic-bezier(.34,1.56,.64,1);pointer-events:none}
#achtoast.show{transform:translateX(-50%) translateY(0)}
.ati{font-size:32px}
.att .atn{font-family:'Cinzel',serif;font-size:13px;font-weight:700;color:#7ec850;letter-spacing:1px}
.att .ats{font-size:11px;color:rgba(255,255,255,.7)}
#gbanner{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%) scale(0);background:rgba(4,18,2,.96);border:3px solid #7ec850;border-radius:16px;padding:18px 40px;font-family:'Cinzel',serif;font-size:22px;font-weight:700;color:#7ec850;z-index:180;text-align:center;transition:transform .35s cubic-bezier(.34,1.56,.64,1);pointer-events:none;box-shadow:0 0 60px rgba(126,200,80,.45)}
#gbanner.show{transform:translate(-50%,-50%) scale(1)}
#modal{position:fixed;inset:0;background:rgba(0,0,0,.8);z-index:100;display:flex;align-items:center;justify-content:center;backdrop-filter:blur(8px)}
#modal.hidden{display:none}
.parch{background:radial-gradient(ellipse at 22% 14%,rgba(200,240,180,.3)0%,transparent 54%),linear-gradient(160deg,#e8f5d8 0%,#c8e8a8 38%,#a8d070 72%,#88b840 100%);border:4px solid #4a8018;border-radius:18px;box-shadow:0 30px 90px rgba(0,0,0,.9),inset 0 2px 0 rgba(255,255,255,.3);max-width:560px;width:96%;padding:28px 36px 24px;position:relative;animation:scUp .45s cubic-bezier(.34,1.56,.64,1);color:#1a3006}
@keyframes scUp{from{transform:scale(.65) translateY(40px);opacity:0}to{transform:scale(1);opacity:1}}
.pi{position:absolute;inset:10px;border:1px solid rgba(74,128,24,.22);border-radius:12px;pointer-events:none}
.pc{position:absolute;font-size:16px;color:#4a8018;opacity:.36;font-family:'Cinzel',serif}
.pc.tl{top:14px;left:18px}.pc.tr{top:14px;right:18px}.pc.bl{bottom:14px;left:18px}.pc.br{bottom:14px;right:18px}
.m-tier{font-family:'Cinzel',serif;font-size:10px;letter-spacing:5px;color:#2a5c08;text-align:center;text-transform:uppercase;margin-bottom:8px}
.m-gate-card{display:flex;align-items:center;gap:14px;margin-bottom:16px;padding:12px 18px;background:rgba(74,128,24,.13);border-radius:12px;border:2px solid rgba(74,128,24,.25)}
.m-gate-ico{font-size:42px;flex-shrink:0}
.m-gate-right{flex:1}
.m-gate-name{font-family:'Cinzel',serif;font-size:15px;font-weight:700;color:#2a5c08;letter-spacing:2px}
.m-gate-tool{display:flex;align-items:center;gap:6px;margin-top:5px;padding:5px 10px;background:rgba(74,128,24,.15);border:1px solid rgba(74,128,24,.35);border-radius:8px;font-size:12px;font-weight:700;color:#1a5808}
.m-gate-tool .tool-ico{font-size:18px}
.m-gate-skipbtn{display:flex;align-items:center;gap:8px;width:100%;margin-bottom:14px;padding:10px 16px;background:linear-gradient(180deg,rgba(60,140,20,.85),rgba(30,90,10,.85));border:2px solid #7ec850;border-radius:11px;color:#d0f0a0;cursor:pointer;font-family:'Nunito',sans-serif;font-size:15px;font-weight:800;transition:all .2s}
.m-gate-skipbtn:hover{background:linear-gradient(180deg,rgba(80,160,30,.9),rgba(40,110,15,.9));box-shadow:0 4px 18px rgba(126,200,80,.4);transform:scale(1.02)}
.m-gate-skipbtn .sb-ico{font-size:22px;flex-shrink:0}
.m-gate-skipbtn .sb-txt{text-align:left}
.m-gate-skipbtn .sb-main{font-size:14px;font-weight:800;display:block}
.m-gate-skipbtn .sb-sub{font-size:11px;color:rgba(200,240,160,.7);display:block;margin-top:1px}
.m-sent{font-family:'Nunito',sans-serif;font-size:22px;font-weight:800;text-align:center;line-height:1.55;margin-bottom:6px}
.m-blank{display:inline-block;min-width:90px;border-bottom:3px solid #4a8018;text-align:center;color:#1a5808;padding:0 8px}
.m-basefm{font-size:13px;font-style:italic;color:#3a6010;text-align:center;margin-bottom:18px}
.m-opts{display:flex;flex-direction:column;gap:9px;margin-bottom:12px}
.m-opt{background:linear-gradient(180deg,rgba(255,255,255,.24)0%,rgba(255,255,255,.05)100%);border:2px solid rgba(74,128,24,.42);border-radius:11px;color:#1a3006;cursor:pointer;font-family:'Nunito',sans-serif;font-size:20px;font-weight:700;padding:12px 18px;text-align:left;transition:all .18s;box-shadow:0 2px 6px rgba(0,0,0,.12)}
.m-opt .ol{display:inline-flex;align-items:center;justify-content:center;width:30px;height:30px;background:#4a8018;color:#e8f5d8;border-radius:9px;font-family:'Cinzel',serif;font-size:13px;font-weight:700;margin-right:12px;flex-shrink:0}
.m-opt:hover:not(:disabled){background:rgba(200,240,150,.45);transform:translateX(6px);border-color:#4a8018}
.m-opt.ok{background:linear-gradient(180deg,#c8f5c0,#78d560);border-color:#3a8030!important}
.m-opt.bad{background:linear-gradient(180deg,#f5c0c0,#d06060);border-color:#903030!important;animation:shk .35s}
@keyframes shk{0%,100%{transform:translateX(0)}25%,75%{transform:translateX(-9px)}50%{transform:translateX(9px)}}
.m-fb{font-family:'Cinzel',serif;font-size:12px;font-weight:700;letter-spacing:2px;text-align:center;min-height:20px}
.m-fb.ok{color:#2a7020}.m-fb.bad{color:#8a2020}
.m-stats{display:flex;justify-content:center;gap:18px;margin-top:8px}
.m-stat{font-family:'Cinzel',serif;font-size:11px;color:#3a6010;display:flex;align-items:center;gap:4px}
#lvc{position:fixed;inset:0;background:rgba(0,0,0,.84);z-index:200;display:flex;align-items:center;justify-content:center}
#lvc.hidden{display:none}
.lcc{background:linear-gradient(150deg,#0a1e04,#051202);border:3px solid #7ec850;border-radius:20px;max-width:480px;width:95%;padding:38px;text-align:center;box-shadow:0 0 90px rgba(126,200,80,.3);animation:zIn .6s cubic-bezier(.34,1.56,.64,1)}
@keyframes zIn{from{transform:scale(.65);opacity:0}to{transform:scale(1);opacity:1}}
.lc-ico{font-size:62px;animation:wb 3s ease-in-out infinite alternate}
@keyframes wb{from{transform:rotate(-6deg)}to{transform:rotate(6deg)}}
.lc-t{font-family:'Cinzel',serif;font-size:28px;font-weight:900;color:#7ec850;text-shadow:0 0 24px rgba(126,200,80,.4);margin:10px 0 6px}
.lc-s{font-family:'Nunito',sans-serif;font-size:15px;color:#90c880;margin-bottom:22px;line-height:1.5}
.lc-sts{display:flex;justify-content:center;gap:22px;margin-bottom:22px;flex-wrap:wrap}
.lc-sv{font-family:'Cinzel',serif;font-size:24px;font-weight:700;color:#7ec850;display:block}
.lc-sl{font-family:'Nunito',sans-serif;font-size:10px;color:#5a7850;letter-spacing:2px;text-transform:uppercase}
.lc-ah{display:flex;flex-wrap:wrap;justify-content:center;gap:7px;margin-bottom:20px}
.ab{background:rgba(126,200,80,.14);border:1px solid rgba(126,200,80,.3);border-radius:8px;padding:4px 10px;font-size:11px;color:#7ec850;font-family:'Cinzel',serif}
#ge{position:fixed;inset:0;background:rgba(0,0,0,.92);z-index:300;display:flex;align-items:center;justify-content:center}
#ge.hidden{display:none}
.gec{background:linear-gradient(150deg,#e8f5d8,#c8e8a8 40%,#a0c870 100%);border:4px solid #4a8018;border-radius:20px;max-width:560px;width:95%;padding:42px;text-align:center;color:#1a3006;box-shadow:0 0 90px rgba(126,200,80,.5);animation:zIn .6s cubic-bezier(.34,1.56,.64,1);position:relative}
.gei{position:absolute;inset:10px;border:1px solid rgba(74,128,24,.22);border-radius:14px;pointer-events:none}
.ge-ico{font-size:62px;animation:wb 4s ease-in-out infinite alternate}
.ge-pre{font-family:'Cinzel',serif;font-size:9px;letter-spacing:5px;color:#4a8018;text-transform:uppercase;margin-bottom:4px}
.ge-t{font-family:'Cinzel',serif;font-size:26px;font-weight:900;color:#1a3006;margin-bottom:14px;line-height:1.2}
.ge-sts{display:flex;justify-content:center;gap:22px;margin-bottom:20px;flex-wrap:wrap}
.ge-sv{font-family:'Cinzel',serif;font-size:24px;font-weight:700;color:#4a8018;display:block}
.ge-sl{font-family:'Nunito',sans-serif;font-size:10px;color:#3a6010;letter-spacing:2px;text-transform:uppercase}
.ge-ah{display:flex;flex-wrap:wrap;justify-content:center;gap:8px;margin-bottom:18px}
#ss{position:absolute;inset:0;z-index:200;background:radial-gradient(ellipse at 50% 30%,#1a6818,#040a02 100%);display:flex;align-items:center;justify-content:center}
#ss.hidden{display:none}
.ssc{background:rgba(4,14,2,.95);border:3px solid #7ec850;border-radius:22px;padding:40px 46px;text-align:center;max-width:520px;width:95%;box-shadow:0 0 90px rgba(126,200,80,.2)}
.ss-lo{font-size:60px;animation:bob 2.5s ease-in-out infinite}
@keyframes bob{0%,100%{transform:translateY(0)}50%{transform:translateY(-10px)}}
.ss-sub{font-family:'Cinzel',serif;font-size:10px;letter-spacing:5px;color:#3a7018;text-transform:uppercase;margin-bottom:4px}
.ss-ti{font-family:'Cinzel',serif;font-size:clamp(24px,5vw,46px);font-weight:900;color:#7ec850;text-shadow:0 0 32px rgba(126,200,80,.5);line-height:1.1;margin-bottom:6px}
.ss-tg{font-family:'Nunito',sans-serif;font-size:16px;color:#6a9850;margin-bottom:10px}
.ss-de{font-family:'Nunito',sans-serif;font-size:13px;color:#3a5838;margin-bottom:24px;line-height:1.7}
.ss-de b{color:#7ec850}
.ss-lb{font-family:'Cinzel',serif;font-size:11px;letter-spacing:3px;color:#7ec850;text-transform:uppercase;display:block;margin-bottom:8px}
.ss-in{background:rgba(255,255,255,.05);border:2px solid #2a5810;border-radius:9px;color:#c8f0a0;font-family:'Nunito',sans-serif;font-size:18px;padding:11px 18px;text-align:center;outline:none;width:100%;margin-bottom:20px;transition:border-color .3s}
.ss-in::placeholder{color:rgba(200,240,160,.2)}
.ss-in:focus{border-color:#7ec850;box-shadow:0 0 14px rgba(126,200,80,.2)}
.bg{background:linear-gradient(180deg,#3a7010,#1a4808 60%,#0e3004 100%);border:2px solid #7ec850;border-radius:11px;color:#c8f080;cursor:pointer;font-family:'Cinzel',serif;font-size:15px;font-weight:700;letter-spacing:3px;padding:14px 42px;text-transform:uppercase;transition:all .25s;box-shadow:0 6px 18px rgba(0,0,0,.6)}
.bg:hover{background:linear-gradient(180deg,#4a8820,#2a5810 60%,#1a4408 100%);box-shadow:0 8px 26px rgba(0,0,0,.6),0 0 32px rgba(126,200,80,.28);transform:translateY(-2px)}
.bg:active{transform:translateY(1px)}
.ft{position:fixed;font-family:'Cinzel',serif;font-size:22px;font-weight:700;pointer-events:none;z-index:150;animation:ftu 1.3s ease forwards;text-shadow:0 2px 8px rgba(0,0,0,.9)}
@keyframes ftu{0%{transform:translateY(0) scale(1.2);opacity:1}100%{transform:translateY(-110px) scale(.8);opacity:0}}
.ft.ok{color:#4caf50}.ft.bad{color:#e53935}.ft.coin{color:#ffd54f}.ft.tool{color:#80cfff}
.cf{position:fixed;pointer-events:none;z-index:200;animation:cff linear forwards}
@keyframes cff{0%{opacity:1;transform:translateY(-10px) rotate(0)}100%{opacity:0;transform:translateY(110vh) rotate(720deg)}}
</style>
</head>
<body>
<div id="G">
<div id="ss">
  <div class="ssc">
    <div class="ss-lo">üå¥</div>
    <div class="ss-sub">Grammar Adventure RPG</div>
    <div class="ss-ti">Maze of Verbs</div>
    <div class="ss-tg">Jungle Ruins ‚Äî Irregular Verbs Quest</div>
    <div class="ss-de">
      üß≠ Walk through the <b>jungle labyrinth</b> as an explorer<br>
      üîí Gates <b>block corridors</b> ‚Äî answer grammar questions to pass<br>
      ü™ì Each gate shows <b>which tool to use</b> as a shortcut<br>
      ‚û°Ô∏è <b>Yellow arrows</b> always show you the way!
    </div>
    <label class="ss-lb">Your Explorer's Name</label>
    <input class="ss-in" id="nameIn" type="text" placeholder="Enter your name‚Ä¶" maxlength="22" autocomplete="off">
    <button class="bg" id="startBtn">üåø Enter the Jungle</button>
  </div>
</div>

<canvas id="gc"></canvas>

<div id="hud">
  <div class="av" title="Your hero">üß≠<div class="av-lv" id="avLv">1</div></div>
  <div class="hstat">
    <div class="hrow" data-tip="‚ù§Ô∏è HP ‚Äî Lives remaining. Lose 1 for each wrong answer!">
      <span class="hlabel">‚ù§Ô∏è HP</span>
      <div class="hbar"><div class="hbar-fill hp" id="hpBar" style="width:100%"></div></div>
      <span class="hval" id="hpVal">3/3</span>
    </div>
    <div class="hrow" data-tip="‚≠ê XP ‚Äî Experience points. Fill bar to level up!">
      <span class="hlabel">‚≠ê XP</span>
      <div class="hbar"><div class="hbar-fill xp" id="xpBar" style="width:0%"></div></div>
      <span class="hval" id="xpVal">0/100</span>
    </div>
  </div>
  <div class="hmid">
    <div class="hlbl" id="progLbl">Level 1 ‚Äî Open all gates!</div>
    <div class="hpbg"><div class="hpfg" id="progFg" style="width:0%"></div><div class="hptxt" id="progTxt">0/6 gates</div></div>
  </div>
  <div class="htimer" id="timer" data-tip="‚è± Time ‚Äî How long you've been in this level">00:00</div>
  <div class="hcurs">
    <div class="hcur g" data-tip="üíé Gems ‚Äî Rare currency. Used for extra tools!"><span>üíé</span><span id="gemC">5</span><span style="font-size:9px;color:rgba(232,121,249,.6)">gems</span></div>
    <div class="hcur c" data-tip="ü™ô Coins ‚Äî Buy hints for 5 coins each!"><span>ü™ô</span><span id="coinC">100</span><span style="font-size:9px;color:rgba(255,213,79,.6)">coins</span></div>
  </div>
</div>

<div id="lvbadge">LEVEL <span id="lvNum">1</span></div>
<div id="mm"><canvas id="mmcv" width="108" height="108"></canvas></div>

<div id="qpanel">
  <div class="qp-h">üìã Quest</div>
  <div class="qp-r" id="qr1"><span class="qi">üîí</span><span id="qr1t">Open all gates (0 done)</span></div>
  <div class="qp-r" id="qr2"><span class="qi">üö™</span><span id="qr2t">Reach the exit door</span></div>
</div>

<div id="toolpanel">
  <div class="tp-title">TOOLS</div>
  <div class="ts on" id="t0">
    <div class="ts-ico">üë£</div><div class="ts-nm">Walk</div>
    <div class="ts-tooltip">
      <div class="tt-title">Walk Mode</div>
      <div class="tt-works">Click anywhere to move</div>
      <div class="tt-tip">Click a gate to answer a question</div>
    </div>
  </div>
  <div class="ts" id="t1">
    <div class="ts-ico">ü™ì</div><div class="ts-nm">Axe</div>
    <span class="ts-cnt" id="tc1">3</span>
    <div class="ts-tooltip">
      <div class="tt-title">ü™ì Axe</div>
      <div class="tt-works">Works on: üåø Vine Walls</div>
      <div class="tt-tip">Select ‚Üí click a vine gate to chop through!</div>
    </div>
  </div>
  <div class="ts" id="t2">
    <div class="ts-ico">‚õèÔ∏è</div><div class="ts-nm">Pick</div>
    <span class="ts-cnt" id="tc2">2</span>
    <div class="ts-tooltip">
      <div class="tt-title">‚õèÔ∏è Pickaxe</div>
      <div class="tt-works">Works on: ‚õ©Ô∏è Iron Gate, üî± Portcullis</div>
      <div class="tt-tip">Select ‚Üí click a metal gate to smash it!</div>
    </div>
  </div>
  <div class="ts" id="t3">
    <div class="ts-ico">üóùÔ∏è</div><div class="ts-nm">Key</div>
    <span class="ts-cnt" id="tc3">1</span>
    <div class="ts-tooltip">
      <div class="tt-title">üóùÔ∏è Magic Key</div>
      <div class="tt-works">Works on: üîÆ Rune Doors</div>
      <div class="tt-tip">Select ‚Üí click a rune door to unlock it!</div>
    </div>
  </div>
  <div class="ts" id="t4">
    <div class="ts-ico">‚ú®</div><div class="ts-nm">Magic</div>
    <span class="ts-cnt" id="tc4">1</span>
    <div class="ts-tooltip">
      <div class="tt-title">‚ú® Magic Scroll</div>
      <div class="tt-works">Works on: ALL gate types!</div>
      <div class="tt-tip">Instant clear ‚Äî use for tough spots!</div>
    </div>
  </div>
</div>

<div id="bbar">
  <button class="bb" id="hintBtn">üí° Hint (‚àí5ü™ô)</button>
  <div id="bbhint">Click to walk ¬∑ Click gates to answer ¬∑ Arrows show the way</div>
  <button class="bb" id="pauseBtn">‚è∏ Pause</button>
</div>

<div id="spch"></div>
<div id="achtoast">
  <div class="ati" id="ati">üèÜ</div>
  <div class="att"><div class="atn" id="atn">Achievement!</div><div class="ats" id="ats">Unlocked</div></div>
</div>
<div id="gbanner">üîì Gate Opened!</div>
<div id="wrongtool">
  <span class="wt-ico" id="wt-ico">‚ùå</span>
  <div class="wt-title" id="wt-title">Wrong Tool!</div>
  <div class="wt-msg" id="wt-msg">That tool won't work here.</div>
  <div class="wt-suggest" id="wt-suggest">Use ü™ì Axe instead!</div>
</div>

<div id="modal" class="hidden">
  <div class="parch">
    <div class="pi"></div>
    <span class="pc tl">üåø</span><span class="pc tr">ü¶ú</span><span class="pc bl">üå∫</span><span class="pc br">ü¶ã</span>
    <div class="m-tier" id="mTier">Common Verbs ‚Äî Tier I</div>
    <div class="m-gate-card">
      <div class="m-gate-ico" id="mGIco">‚õ©Ô∏è</div>
      <div class="m-gate-right">
        <div class="m-gate-name" id="mGName">IRON GATE</div>
        <div class="m-gate-tool">
          <span class="tool-ico" id="mToolIco">‚õèÔ∏è</span>
          <span id="mToolMsg">Or use Pickaxe to skip (2 left)</span>
        </div>
      </div>
    </div>
    <button class="m-gate-skipbtn hidden" id="mSkipBtn">
      <span class="sb-ico" id="mSkipIco">‚õèÔ∏è</span>
      <span class="sb-txt">
        <span class="sb-main" id="mSkipMain">Use Pickaxe to instantly destroy this gate!</span>
        <span class="sb-sub" id="mSkipSub">2 uses remaining ‚Äî no question needed</span>
      </span>
    </button>
    <div class="m-sent" id="mSent"></div>
    <div class="m-basefm" id="mBase">Base form: "go"</div>
    <div class="m-opts" id="mOpts"></div>
    <div class="m-fb" id="mFb"></div>
    <div class="m-stats">
      <div class="m-stat">üéØ Streak: <span id="mStr">0</span></div>
      <div class="m-stat">‚úÖ Accuracy: <span id="mAcc">‚Äî</span></div>
      <div class="m-stat">ü™ô +10 on correct</div>
    </div>
  </div>
</div>

<div id="lvc" class="hidden">
  <div class="lcc">
    <div class="lc-ico">üéä</div>
    <div class="lc-t" id="lcT">Section Cleared!</div>
    <div class="lc-s" id="lcS">You escaped the jungle!</div>
    <div class="lc-sts">
      <div><span class="lc-sv" id="lcSc">0</span><span class="lc-sl">Score</span></div>
      <div><span class="lc-sv" id="lcAc">100%</span><span class="lc-sl">Accuracy</span></div>
      <div><span class="lc-sv" id="lcTm">0:00</span><span class="lc-sl">Time</span></div>
      <div><span class="lc-sv" id="lcRw">+50ü™ô</span><span class="lc-sl">Reward</span></div>
    </div>
    <div class="lc-ah" id="lcAh"></div>
    <button class="bg" id="nextBtn">Next Level ‚ñ∂</button>
  </div>
</div>

<div id="ge" class="hidden">
  <div class="gec"><div class="gei"></div>
    <div class="ge-ico">üèÜ</div>
    <div class="ge-pre">Certificate of Mastery</div>
    <div class="ge-t" id="geT">Champion of the Jungle!</div>
    <div class="ge-sts">
      <div><span class="ge-sv" id="geSc">0</span><span class="ge-sl">Score</span></div>
      <div><span class="ge-sv" id="geAc">0%</span><span class="ge-sl">Accuracy</span></div>
      <div><span class="ge-sv" id="geTm">0:00</span><span class="ge-sl">Time</span></div>
      <div><span class="ge-sv" id="geLv">1</span><span class="ge-sl">Levels</span></div>
    </div>
    <div class="ge-ah" id="geAh"></div>
    <button class="bg" id="replayBtn">üîÑ Play Again</button>
  </div>
</div>

<script>
(()=>{
'use strict';
const VERBS=[
  {b:'go',p:'went',d:['goed','gone'],t:1},{b:'take',p:'took',d:['taked','tooked'],t:1},
  {b:'see',p:'saw',d:['seed','seen'],t:1},{b:'come',p:'came',d:['comed','come'],t:1},
  {b:'get',p:'got',d:['getted','gotten'],t:1},{b:'make',p:'made',d:['maked','maed'],t:1},
  {b:'know',p:'knew',d:['knowed','known'],t:1},{b:'think',p:'thought',d:['thinked','thunk'],t:1},
  {b:'say',p:'said',d:['sayed','sed'],t:1},{b:'give',p:'gave',d:['gived','gaven'],t:1},
  {b:'find',p:'found',d:['finded','founded'],t:1},{b:'tell',p:'told',d:['telled','tolded'],t:1},
  {b:'write',p:'wrote',d:['writed','written'],t:2},{b:'break',p:'broke',d:['breaked','broked'],t:2},
  {b:'speak',p:'spoke',d:['speaked','spoken'],t:2},{b:'drive',p:'drove',d:['drived','driven'],t:2},
  {b:'choose',p:'chose',d:['choosed','chosen'],t:2},{b:'steal',p:'stole',d:['stealed','stolen'],t:2},
  {b:'wear',p:'wore',d:['weared','worn'],t:2},{b:'forget',p:'forgot',d:['forgetted','forgotten'],t:2},
  {b:'begin',p:'began',d:['beginned','begun'],t:2},{b:'swim',p:'swam',d:['swimmed','swum'],t:2},
  {b:'seek',p:'sought',d:['seeked','sook'],t:3},{b:'flee',p:'fled',d:['fleed','flied'],t:3},
  {b:'bind',p:'bound',d:['binded','bounden'],t:3},{b:'weave',p:'wove',d:['weaved','woven'],t:3},
  {b:'slay',p:'slew',d:['slayed','slain'],t:3},{b:'awake',p:'awoke',d:['awaked','awaken'],t:3},
  {b:'shine',p:'shone',d:['shined','shon'],t:3},{b:'deal',p:'dealt',d:['dealed','dealt'],t:3},
];
const SENTS=[
  'Yesterday our explorer ______ through the jungle gate.',
  'The ancient wizard ______ a powerful spell.',
  'She bravely ______ the secret chamber.',
  'He ______ through the dark jungle corridor.',
  'They ______ the hidden passage at night.',
  'The explorer ______ a strange artifact.',
  'She ______ the answer to the ancient riddle.',
  'He ______ deep into the jungle labyrinth.',
  'The guardian ______ into the shadows.',
  'The brave explorer ______ the treasure map high.',
  'She ______ about the danger and escaped.',
  'Our guide ______ us through the jungle.',
  'The hero ______ the beast blocking the path.',
  'He ______ the rune inscription on the stone.',
];
const TIER_LBL={1:'Common Verbs ‚Äî Tier I',2:'Intermediate ‚Äî Tier II',3:'Advanced ‚Äî Tier III'};
const GATE_DATA={
  iron_gate:{nm:'STONE GATE',ic:'‚õ©Ô∏è',tool:'t2',toolIco:'‚õèÔ∏è',toolNm:'Pickaxe',msg:'Use ‚õèÔ∏è Pickaxe to smash the stone gate!'},
  vine_gate:{nm:'VINE WALL',ic:'üåø',tool:'t1',toolIco:'ü™ì',toolNm:'Axe',msg:'Use ü™ì Axe to chop through the vines!'},
  rune_door:{nm:'RUNE DOOR',ic:'üîÆ',tool:'t3',toolIco:'üóùÔ∏è',toolNm:'Key',msg:'Use üóùÔ∏è Key to unlock the rune magic!'},
  spike_gate:{nm:'BAMBOO GATE',ic:'üéã',tool:'t2',toolIco:'‚õèÔ∏è',toolNm:'Pickaxe',msg:'Use ‚õèÔ∏è Pickaxe to break the bamboo spikes!'},
};
const TOOL_COMPAT={t1:['vine_gate'],t2:['iron_gate','spike_gate'],t3:['rune_door'],t4:['iron_gate','vine_gate','rune_door','spike_gate']};
const TOOL_ICO={t1:'ü™ì',t2:'‚õèÔ∏è',t3:'üóùÔ∏è',t4:'‚ú®'};
const TOOL_NM={t1:'Axe',t2:'Pickaxe',t3:'Key',t4:'Magic'};
const WRONG_MSGS={
  t1:{iron_gate:'ü™ì Axe can\'t break stone! Use ‚õèÔ∏è Pickaxe instead.',vine_gate:null,rune_door:'ü™ì Axe can\'t break magic runes! Use üóùÔ∏è Key instead.',spike_gate:'ü™ì Axe can\'t break bamboo spikes! Use ‚õèÔ∏è Pickaxe instead.'},
  t2:{iron_gate:null,vine_gate:'‚õèÔ∏è Pickaxe can\'t cut vines! Use ü™ì Axe instead.',rune_door:'‚õèÔ∏è Pickaxe won\'t work on magic! Use üóùÔ∏è Key instead.',spike_gate:null},
  t3:{iron_gate:'üóùÔ∏è Key can\'t open stone bars! Use ‚õèÔ∏è Pickaxe instead.',vine_gate:'üóùÔ∏è Key doesn\'t affect plants! Use ü™ì Axe instead.',rune_door:null,spike_gate:'üóùÔ∏è Key can\'t break bamboo! Use ‚õèÔ∏è Pickaxe instead.'},
};
const NPC_LINES=[
  ['Follow the yellow arrows!','The exit is ahead!','Open all gates first!'],
  ['Answer correctly ‚Äî gates open!','Use tools as shortcuts!','Watch the flashing gates!'],
  ['Woof! Follow me! üêï','*sniffs* This way!','Bark! Gate over there!'],
  ['Right tool = instant open!','Magic works on everything!','Need a key? Check your tools!'],
];
const ACHS=[
  {id:'a1',nm:'Gate Breaker',ds:'Open your first gate',ic:'üîì',fn:s=>s.cl>=1},
  {id:'a2',nm:'Sharpshooter',ds:'5 correct answers in a row',ic:'üéØ',fn:s=>s.str>=5},
  {id:'a3',nm:'Handyman',ds:'Use a tool on a gate',ic:'ü™ì',fn:s=>s.tu>=1},
  {id:'a4',nm:'Trailblazer',ds:'Clear 10 gates total',ic:'üó∫Ô∏è',fn:s=>s.tc>=10},
  {id:'a5',nm:'Scholar',ds:'20 correct answers',ic:'üìö',fn:s=>s.cor>=20},
  {id:'a6',nm:'Pathfinder',ds:'Complete Level 1',ic:'üèÅ',fn:s=>s.lvc>=1},
  {id:'a7',nm:'Untouchable',ds:'Level with no HP loss',ic:'üõ°Ô∏è',fn:s=>s.hloss===0},
  {id:'a8',nm:'Speedster',ds:'Clear level under 90s',ic:'‚ö°',fn:s=>s.lt<90},
  {id:'a9',nm:'Perfectionist',ds:'100% accuracy in a level',ic:'üíé',fn:s=>s.lacc>=100},
];

const CV=document.getElementById('gc');const CX=CV.getContext('2d');
const MC=document.getElementById('mmcv');const MX=MC.getContext('2d');
const COLS=15,ROWS=11;
const TW=100,TH=50,WH=82;
let W=0,H=0,OX=0,OY=0,SC=1;
let camX=0,camY=0,ctX=0,ctY=0;

function resize(){
  W=CV.width=window.innerWidth;H=CV.height=window.innerHeight;
  const mW=(COLS+ROWS)*TW/2,mH=(COLS+ROWS)*TH/2+WH+20;
  SC=Math.min(W*.95/mW,(H-66)*.92/mH,2.0);
  OX=W/2;OY=66+(H-66)/2-mH*SC/2+TH*SC*2.6;
  genBg();
}
function iso(c,r){return{x:OX+(c-r)*TW/2*SC-camX,y:OY+(c+r)*TH/2*SC-camY};}
function s2g(sx,sy){
  const wx=sx+camX-OX,wy=sy+camY-OY;
  return{col:Math.round((wx/(TW/2*SC)+wy/(TH/2*SC))/2),row:Math.round((wy/(TH/2*SC)-wx/(TW/2*SC))/2)};
}

let maze=[],gates=[],npcs=[],decors=[];
let verbQ=[],pPos={col:1,row:1},exitPos={col:COLS-2,row:ROWS-2};
let playerName='Explorer';
let score=0,hp=3,mhp=3,xp=0,lvl=1,coins=100,gems=5;
let totAns=0,corrAns=0,clrObs=0,totGates=6;
let active=false,inModal=false,paused=false;
let elapsed=0,timerID=null,curLvl=1,lastTs=0;
let facing=1,walkT=0;
let mPath=[],mTimer=0;const MDUR=0.16;
let curGate=null,curVerb=null;
let parts=[],gHits=[],nHits=[];
let opening=[];let arrowPath=[];const TOTAL_LVL=5;
let ST={cl:0,str:0,tu:0,tc:0,cor:0,lvc:0,hloss:0,lt:0,lacc:0};
let achDone=new Set();let lvlTs=0,lvlTot=0,lvlCorr=0;
const STOCK={t1:3,t2:2,t3:1,t4:1};
let curTool='t0';

// ‚ïê‚ïê JUNGLE CLOUDS ‚ïê‚ïê
let bgClouds=[];
function genBg(){
  bgClouds=[];
  for(let i=0;i<6;i++){
    bgClouds.push({x:W*(0.05+i*.17)+Math.random()*W*.05,y:H*(0.04+Math.random()*.10),r:W*(0.04+Math.random()*.04),speed:0.12+Math.random()*.18});
  }
}

// ‚ïê‚ïê JUNGLE BACKGROUND ‚ïê‚ïê
function drawBg(){
  // Sky ‚Äî bright tropical blue
  const sky=CX.createLinearGradient(0,0,0,H*.55);
  sky.addColorStop(0,'#4ab8e8');sky.addColorStop(.4,'#74ccf0');sky.addColorStop(.7,'#90daf5');sky.addColorStop(1,'#b0eaf8');
  CX.fillStyle=sky;CX.fillRect(0,0,W,H*.6);

  // White clouds
  bgClouds.forEach(cl=>{
    cl.x+=cl.speed*.3;if(cl.x>W*1.1)cl.x=-cl.r*2;
    CX.save();CX.globalAlpha=.92;
    for(let i=0;i<4;i++){
      CX.beginPath();CX.arc(cl.x+i*cl.r*.55,cl.y+(i%2)*cl.r*.2,cl.r*(0.6+i*.15),0,Math.PI*2);
      CX.fillStyle='rgba(255,255,255,.95)';CX.fill();
    }
    CX.restore();
  });

  // Birds (tiny)
  const bt=Date.now()/2000;
  for(let i=0;i<5;i++){
    const bx=((bt*60+i*180)%W),by=H*.14+i*H*.025;
    CX.save();CX.fillStyle='#1a2a1a';CX.globalAlpha=.7;
    CX.beginPath();CX.ellipse(bx,by,5,2.5,Math.sin(bt+i)*0.3,0,Math.PI*2);CX.fill();
    CX.beginPath();CX.ellipse(bx+8,by-1,4,2,Math.sin(bt+i+.5)*0.3,0,Math.PI*2);CX.fill();
    CX.restore();
  }

  // Distant mountains (misty green)
  for(let m=0;m<5;m++){
    const mx=W*(0.05+m*.22),mw=W*(0.18+m*.03),mh=H*(0.12+m*.02);
    const my=H*.28-mh;
    CX.beginPath();CX.moveTo(mx-mw/2,H*.38);CX.lineTo(mx,my);CX.lineTo(mx+mw/2,H*.38);CX.closePath();
    const mg=CX.createLinearGradient(mx,my,mx,H*.38);
    mg.addColorStop(0,'rgba(120,180,90,.65)');mg.addColorStop(.5,'rgba(80,140,60,.55)');mg.addColorStop(1,'rgba(40,80,20,.4)');
    CX.fillStyle=mg;CX.fill();
  }

  // Jungle trees (back layer)
  for(let t=0;t<10;t++){
    const tx=W*(0.02+t*.105),th=H*(0.13+((t*7)%5)*.03);
    // trunk
    CX.fillStyle='#5a3a18';CX.fillRect(tx-4,H*.38,8,th);
    // foliage blobs
    const gc=CX.createRadialGradient(tx,H*.38-th*.3,4,tx,H*.38-th*.3,th*.5);
    gc.addColorStop(0,'#5ec830');gc.addColorStop(.5,'#3a9c18');gc.addColorStop(1,'rgba(20,70,5,.0)');
    CX.fillStyle=gc;CX.beginPath();CX.ellipse(tx,H*.38-th*.3,th*.44,th*.5,0,0,Math.PI*2);CX.fill();
  }

  // Palm trees (mid layer)
  const palmPositions=[{x:W*.12,h:H*.22},{x:W*.28,h:H*.26},{x:W*.55,h:H*.24},{x:W*.75,h:H*.22},{x:W*.9,h:H*.25}];
  palmPositions.forEach(({x:px,h:ph})=>{
    const sway=Math.sin(Date.now()/1400+px)*3;
    // trunk
    CX.save();CX.translate(px,H*.44);
    CX.strokeStyle='#7a5228';CX.lineWidth=9;CX.lineCap='round';
    CX.beginPath();CX.moveTo(0,0);CX.bezierCurveTo(sway*2,-(ph*.3),sway*3,-(ph*.6),sway*1.5,-ph);CX.stroke();
    // palm leaves
    const leafColors=['#3eb82a','#4eca34','#2a9a18'];
    for(let l=0;l<7;l++){
      const ang=(l/7)*Math.PI*2+sway*.04;
      const lx=px+sway*1.5+Math.cos(ang)*40,ly=H*.44-ph+Math.sin(ang)*18;
      CX.strokeStyle=leafColors[l%3];CX.lineWidth=5;CX.lineCap='round';
      CX.beginPath();CX.moveTo(px+sway*1.5,H*.44-ph);CX.bezierCurveTo(px+sway*1.5+Math.cos(ang)*22,H*.44-ph+Math.sin(ang)*10,lx,ly,lx+Math.cos(ang)*18,ly+Math.sin(ang)*8);CX.stroke();
    }
    CX.restore();
    // coconuts
    for(let c2=0;c2<3;c2++){CX.fillStyle='#8b6020';CX.beginPath();CX.arc(px+sway*1.5+(c2-1)*10,H*.44-ph+14,5,0,Math.PI*2);CX.fill();}
  });

  // River (winding blue)
  const riverY=H*.46;
  CX.save();
  const riverGrad=CX.createLinearGradient(0,riverY-12,0,riverY+28);
  riverGrad.addColorStop(0,'rgba(80,160,220,.9)');riverGrad.addColorStop(.5,'rgba(60,140,200,.85)');riverGrad.addColorStop(1,'rgba(40,110,180,.7)');
  CX.fillStyle=riverGrad;
  CX.beginPath();CX.moveTo(0,riverY);CX.bezierCurveTo(W*.2,riverY-15,W*.4,riverY+10,W*.6,riverY-8);
  CX.bezierCurveTo(W*.75,riverY-20,W*.9,riverY+12,W,riverY+5);
  CX.lineTo(W,riverY+28);CX.bezierCurveTo(W*.9,riverY+32,W*.75,riverY+16,W*.6,riverY+28);
  CX.bezierCurveTo(W*.4,riverY+40,W*.2,riverY+18,0,riverY+28);CX.closePath();
  CX.fill();
  // river shimmer
  CX.globalAlpha=.25;CX.strokeStyle='#ffffff';CX.lineWidth=2;
  for(let s=0;s<3;s++){
    const sx=((Date.now()/600+s*200)%W);
    CX.beginPath();CX.moveTo(sx,riverY+5);CX.bezierCurveTo(sx+20,riverY,sx+40,riverY+10,sx+60,riverY+3);CX.stroke();
  }
  CX.restore();

  // Ground ‚Äî lush green grass
  const ground=CX.createLinearGradient(0,H*.44,0,H*.58);
  ground.addColorStop(0,'#7ed830');ground.addColorStop(.4,'#5ec218');ground.addColorStop(1,'#3aaa08');
  CX.fillStyle=ground;CX.fillRect(0,H*.44,W,H*.16);

  // Small white flowers on ground
  for(let f=0;f<12;f++){
    const fx=W*(0.04+f*.09)+Math.sin(f*7)*20,fy=H*.46+Math.sin(f*13)*6;
    CX.fillStyle='rgba(255,255,255,.8)';CX.beginPath();CX.arc(fx,fy,3,0,Math.PI*2);CX.fill();
    for(let p=0;p<5;p++){const pa=p*Math.PI*2/5;CX.fillStyle='rgba(255,255,255,.6)';CX.beginPath();CX.ellipse(fx+Math.cos(pa)*5,fy+Math.sin(pa)*5,2.5,1.5,pa,0,Math.PI*2);CX.fill();}
  }

  // Foreground leaves overlay
  CX.save();CX.globalAlpha=.85;
  const leafData=[{x:0,y:H*.52,flip:false},{x:W,y:H*.48,flip:true},{x:0,y:H*.6,flip:false},{x:W*.98,y:H*.62,flip:true}];
  leafData.forEach(({x,y,flip})=>{
    CX.save();if(flip){CX.scale(-1,1);CX.translate(-W,0);}
    // big leaf
    CX.fillStyle='#2c8a10';CX.beginPath();CX.moveTo(x,y);CX.bezierCurveTo(x+40,y-30,x+80,y-10,x+60,y+20);CX.bezierCurveTo(x+40,y+35,x+10,y+20,x,y);CX.fill();
    CX.fillStyle='#3aaa18';CX.beginPath();CX.moveTo(x,y+4);CX.bezierCurveTo(x+30,y-18,x+60,y-4,x+48,y+16);CX.bezierCurveTo(x+30,y+28,x+8,y+18,x,y+4);CX.fill();
    CX.restore();
  });
  CX.restore();

  // Fog at bottom
  const fog=CX.createLinearGradient(0,H*.46,0,H*.62);
  fog.addColorStop(0,'rgba(180,240,160,0)');fog.addColorStop(1,'rgba(100,180,60,.22)');
  CX.fillStyle=fog;CX.fillRect(0,H*.46,W,H*.18);
}

// ‚ïê‚ïê JUNGLE FLOOR TILE ‚ïê‚ïê
function drawFloor(c,r,tint){
  const{x,y}=iso(c,r);const hw=TW/2*SC,hh=TH/2*SC;
  CX.beginPath();CX.moveTo(x,y-hh);CX.lineTo(x+hw,y);CX.lineTo(x,y+hh);CX.lineTo(x-hw,y);CX.closePath();
  if(tint){CX.fillStyle=tint;}else{
    const g=CX.createLinearGradient(x-hw,y-hh,x+hw,y+hh);
    // Grass green jungle floor
    g.addColorStop(0,'#6ad828');g.addColorStop(.45,'#52c418');g.addColorStop(1,'#3ea808');
    CX.fillStyle=g;
  }
  CX.fill();CX.strokeStyle='rgba(20,80,4,.12)';CX.lineWidth=.5;CX.stroke();
  // Small dirt patches
  if((c*11+r*13)%7===0){CX.fillStyle='rgba(139,90,20,.28)';CX.beginPath();CX.ellipse(x+2*SC,y-1*SC,4*SC,2.5*SC,0,0,Math.PI*2);CX.fill();}
  // Small white flowers
  if((c*7+r*11)%8===0){CX.fillStyle='rgba(255,255,255,.7)';CX.beginPath();CX.arc(x-4*SC,y,2*SC,0,Math.PI*2);CX.fill();}
}

// ‚ïê‚ïê JUNGLE BAMBOO WALL ‚ïê‚ïê
function drawWall(c,r){
  const{x,y}=iso(c,r);const hw=TW/2*SC,hh=TH/2*SC,wh=WH*SC;

  // Right face (earthy mud/stone)
  CX.beginPath();CX.moveTo(x+hw,y-wh);CX.lineTo(x,y+hh-wh);CX.lineTo(x,y+hh);CX.lineTo(x+hw,y);CX.closePath();
  const rf=CX.createLinearGradient(x,y-wh,x+hw,y);rf.addColorStop(0,'#7a6a4a');rf.addColorStop(.5,'#5e5030');rf.addColorStop(1,'#4a3e24');
  CX.fillStyle=rf;CX.fill();CX.strokeStyle='rgba(30,20,8,.3)';CX.lineWidth=.8;CX.stroke();

  // Left face
  CX.beginPath();CX.moveTo(x-hw,y-wh);CX.lineTo(x,y+hh-wh);CX.lineTo(x,y+hh);CX.lineTo(x-hw,y);CX.closePath();
  const lf=CX.createLinearGradient(x-hw,y-wh,x,y);lf.addColorStop(0,'#5e5030');lf.addColorStop(.5,'#4a3c20');lf.addColorStop(1,'#3a2e18');
  CX.fillStyle=lf;CX.fill();CX.strokeStyle='rgba(20,12,4,.36)';CX.lineWidth=.8;CX.stroke();

  // Top face ‚Äî green mossy top
  CX.beginPath();CX.moveTo(x,y-hh-wh);CX.lineTo(x+hw,y-wh);CX.lineTo(x,y+hh-wh);CX.lineTo(x-hw,y-wh);CX.closePath();
  const tf=CX.createLinearGradient(x-hw,y-wh,x+hw,y-wh);
  tf.addColorStop(0,'#4ec828');tf.addColorStop(.4,'#5ad630');tf.addColorStop(.7,'#3ab820');tf.addColorStop(1,'#2ea010');
  CX.fillStyle=tf;CX.fill();CX.strokeStyle='rgba(20,80,4,.3)';CX.lineWidth=.7;CX.stroke();

  // Moss patches on top
  CX.save();
  for(let i=0;i<3;i++){CX.fillStyle=`rgba(${30+i*10},${140+i*15},${10+i*5},.6)`;CX.beginPath();CX.ellipse(x+(i-1)*hw*.35,y-wh+(i%2)*3*SC,hw*.2,4*SC,i*.4,0,Math.PI*2);CX.fill();}
  CX.restore();

  // Bamboo stalks on wall
  CX.save();
  const bmbCount=3;
  for(let b=0;b<bmbCount;b++){
    const bx=x-hw*.55+b*hw*.55;
    const bh=wh*(0.55+b*.12);
    // bamboo color alternating
    const bclr=b%2===0?'#8fc040':'#7aaa30';
    CX.fillStyle=bclr;CX.fillRect(bx-2.5*SC,y-bh,5*SC,bh);
    // joints
    for(let j=0;j<3;j++){
      const jy=y-bh*(j+1)/3.5;
      CX.fillStyle='#4a7010';CX.fillRect(bx-3*SC,jy-1.5*SC,6*SC,3*SC);
    }
    // bamboo leaf at top
    CX.fillStyle='rgba(80,160,20,.8)';CX.beginPath();CX.ellipse(bx+8*SC,y-bh+2*SC,12*SC,4*SC,.4,0,Math.PI*2);CX.fill();
  }
  CX.restore();

  // Jungle vines hanging
  if((c*5+r*9)%3===0){drawJungleVine(x-hw*.7,y,'L');}
  if((c*9+r*5)%4===0){drawJungleVine(x+hw*.7,y,'R');}

  // Tropical flowers (random)
  if((c*3+r*11)%6===0){
    const fx=x+hw*.35,fy=y-wh*.6;
    const flc=['#ff6090','#ff8020','#ffe040','#80ff40'];
    CX.fillStyle=flc[(c+r)%4];CX.beginPath();CX.arc(fx,fy,5*SC,0,Math.PI*2);CX.fill();
    CX.fillStyle='rgba(255,255,150,.8)';CX.beginPath();CX.arc(fx,fy,2*SC,0,Math.PI*2);CX.fill();
  }
}

function drawJungleVine(vx,vy,side){
  const s=SC,whs=WH*s;
  CX.save();CX.strokeStyle='#2a6a10';CX.lineWidth=2.5*s;CX.lineCap='round';
  CX.beginPath();CX.moveTo(vx,vy-whs);CX.bezierCurveTo(vx+(side==='L'?-8:8)*s,vy-whs*.6,vx+(side==='L'?6:-6)*s,vy-whs*.28,vx,vy+TH/2*s);CX.stroke();
  const leafColors=['#2a8a10','#3aaa18','#48c020','#5ad028','#28780e'];
  for(let i=0;i<5;i++){const t=(i+.5)/5.5,lx=vx+Math.sin(t*Math.PI)*(side==='L'?-14:14)*s,ly=vy-whs*(1-t);CX.beginPath();CX.ellipse(lx,ly,7*s,4*s,Math.PI/4*(side==='L'?-1:1),0,Math.PI*2);CX.fillStyle=leafColors[i%5];CX.fill();}
  CX.restore();
}

// ‚ïê‚ïê GATE DRAWING ‚ïê‚ïê
function drawGate(c,r,g,idx){
  drawFloor(c,r);
  const{x,y}=iso(c,r);const s=SC;
  const t=Date.now()/800,pulse=.5+.5*Math.sin(t+idx*1.5);
  const oa=g.oa||0,al=1-oa;
  const hw=TW/2*SC,gh=WH*SC*1.18;
  const gd=GATE_DATA[g.type];
  const ag=CX.createRadialGradient(x,y,4,x,y,34*s);
  ag.addColorStop(0,`rgba(255,100,10,${(.25+.15*pulse)*al})`);ag.addColorStop(1,'rgba(0,0,0,0)');
  CX.fillStyle=ag;CX.fillRect(x-40*s,y-40*s,80*s,80*s);
  CX.save();CX.globalAlpha=al;
  if(g.type==='iron_gate'||g.type==='spike_gate'){
    // Stone/bamboo pillars
    for(const sx of[-1,1]){const px=x+sx*hw*.9;
      const pg=CX.createLinearGradient(px-5*s,y-gh,px+5*s,y);
      pg.addColorStop(0,'#6a5030');pg.addColorStop(.5,'#8a6840');pg.addColorStop(1,'#5a4020');
      CX.fillStyle=pg;CX.fillRect(px-5*s,y-gh,10*s,gh);
      CX.strokeStyle='#3a2810';CX.lineWidth=.8;CX.strokeRect(px-5*s,y-gh,10*s,gh);
      // Moss on pillars
      CX.fillStyle='rgba(60,150,20,.5)';CX.fillRect(px-5*s,y-gh,10*s,6*s);
    }
    if(g.type==='iron_gate'){
      const ang=oa*Math.PI*.72;
      for(const[side,sgn]of[[-1,-1],[1,1]]){
        CX.save();CX.translate(x+side*hw*.85,y-gh*.5);CX.rotate(sgn*ang);
        for(let i=0;i<3;i++){
          const bx=side<0?i*hw*.28:-hw*.28*(i+1);
          // bamboo bar instead of iron
          const bg=CX.createLinearGradient(bx,0,bx+4*s,0);
          bg.addColorStop(0,'#6a9020');bg.addColorStop(.4,'#8ab830');bg.addColorStop(1,'#5a8018');
          CX.fillStyle=bg;CX.fillRect(bx,0,4*s,gh*.9);
          // bamboo joints
          for(let j=0;j<3;j++){CX.fillStyle='#3a6008';CX.fillRect(bx-1*s,gh*.9*(j+1)/4,6*s,2.5*s);}
          // leaf at top
          CX.fillStyle='rgba(80,160,20,.7)';CX.beginPath();CX.ellipse(bx+2*s,-10*s,5*s,2.5*s,.3,0,Math.PI*2);CX.fill();
        }
        for(const fy of[.25,.55,.8]){CX.fillStyle='#3a6010';CX.fillRect(side<0?0:-hw*.84,gh*fy,hw*.84,3.5*s);}
        CX.restore();
      }
    } else {
      // Bamboo portcullis going up
      const ry=oa*gh*1.12;
      CX.save();CX.translate(0,-ry);
      const bc=6;
      for(let i=0;i<bc;i++){
        const bx=x-hw*.82+i*hw*1.64/(bc-1);
        const bg=CX.createLinearGradient(bx-2.5*s,0,bx+2.5*s,0);
        bg.addColorStop(0,'#6a9020');bg.addColorStop(.4,'#90b828');bg.addColorStop(1,'#5a8018');
        CX.fillStyle=bg;CX.fillRect(bx-2.5*s,y-gh,5*s,gh+ry);
        // bamboo spike top
        CX.fillStyle='#4a7010';CX.beginPath();CX.moveTo(bx-3*s,y-gh);CX.lineTo(bx,y-gh-14*s);CX.lineTo(bx+3*s,y-gh);CX.closePath();CX.fill();
        // joints
        for(const fy of[.22,.48,.74]){CX.fillStyle='#3a6008';CX.fillRect(bx-3*s,y-gh*fy,6*s,3*s);}
      }
      CX.restore();
    }
  } else if(g.type==='vine_gate'){
    CX.save();CX.globalAlpha*=al;
    CX.fillStyle=`rgba(15,45,5,${.6*al})`;CX.beginPath();CX.moveTo(x-hw,y);CX.lineTo(x,y-TH/2*s);CX.lineTo(x+hw,y);CX.lineTo(x,y+TH/2*s);CX.closePath();CX.fill();
    for(let v=0;v<8;v++){
      const vx=x-hw*.92+v*hw*1.84/7;
      const vc=['#186a04','#2a8010','#1e7808','#38900e','#24860c','#3c9c12','#166208','#2e8a0e'];
      CX.strokeStyle=vc[v];CX.lineWidth=(3+v%2)*s;CX.lineCap='round';
      CX.beginPath();CX.moveTo(vx,y+4*s);CX.bezierCurveTo(vx+10*s,y-gh*.28,vx-8*s,y-gh*.58,vx+6*s,y-gh*.95);CX.stroke();
    }
    for(let i=0;i<16;i++){
      const lx=x+(-hw*.9+i*hw*1.8/15),ly=y-gh*(.12+Math.sin(i*.9)*.66);
      CX.beginPath();CX.ellipse(lx,ly,9*s,6*s,i*.4,0,Math.PI*2);
      CX.fillStyle=`rgba(${30+i*6},${100+i*8},${10+i*4},.92)`;CX.fill();
    }
    // Bright tropical flowers on vine
    const flc=['#ff6090','#ff8020','#ffe040'];
    for(let f=0;f<4;f++){
      const fx=x-hw*.6+f*hw*.4,fy=y-gh*(0.2+f*.2);
      CX.fillStyle=flc[f%3];CX.beginPath();CX.arc(fx,fy,4*s,0,Math.PI*2);CX.fill();
      CX.fillStyle='#fff';CX.beginPath();CX.arc(fx,fy,2*s,0,Math.PI*2);CX.fill();
    }
    if(oa<.4){for(let e=0;e<2;e++){const ex=x+(e===0?-12:12)*s,ey=y-gh*.48;CX.fillStyle=`rgba(255,${80+Math.floor(120*pulse)},0,${.7+.3*pulse})`;CX.save();CX.shadowBlur=12*s;CX.shadowColor='#ff6600';CX.beginPath();CX.ellipse(ex,ey,4.5*s,3.5*s,0,0,Math.PI*2);CX.fill();CX.restore();}}
    CX.restore();
  } else {
    // Rune door ‚Äî ancient stone in jungle
    CX.save();CX.globalAlpha*=al;
    for(const sx of[-1,1]){const px=x+sx*hw*.9;
      const pg=CX.createLinearGradient(px-6*s,y-gh,px+6*s,y);
      pg.addColorStop(0,'#6a5a3a');pg.addColorStop(.5,'#8a7050');pg.addColorStop(1,'#5a4828');
      CX.fillStyle=pg;CX.fillRect(px-6*s,y-gh,12*s,gh);
      // moss on stone
      CX.fillStyle='rgba(50,130,15,.5)';CX.fillRect(px-6*s,y-gh,12*s,8*s);
    }
    CX.beginPath();CX.arc(x,y-gh+2*s,hw*.86,Math.PI,0);CX.lineWidth=15*s;CX.strokeStyle='#6a5a3a';CX.stroke();
    const dg=CX.createLinearGradient(0,y-gh*.88,0,y);dg.addColorStop(0,'#100a04');dg.addColorStop(1,'#060402');CX.fillStyle=dg;
    CX.beginPath();CX.moveTo(x-hw*.74,y);CX.lineTo(x-hw*.74,y-gh*.84);CX.arc(x,y-gh*.84,hw*.74,Math.PI,0);CX.lineTo(x+hw*.74,y);CX.closePath();CX.fill();
    const runes=['üåø','üå∫','ü¶ã','üå¥','üê¶','üçÉ'];
    CX.font=`bold ${11*s}px serif`;CX.textAlign='center';CX.textBaseline='middle';
    CX.globalAlpha*=(.7+.3*pulse);
    runes.forEach((ru,i)=>CX.fillText(ru,x+(i%3-1)*16*s,y-gh*(.32+Math.floor(i/3)*.28)));
    const grd=CX.createRadialGradient(x,y-gh*.5,1,x,y-gh*.5,8*s);
    grd.addColorStop(0,'rgba(80,220,80,1)');grd.addColorStop(.4,`rgba(40,${160+Math.floor(80*pulse)},40,.9)`);grd.addColorStop(1,'rgba(0,100,0,0)');
    CX.fillStyle=grd;CX.save();CX.shadowBlur=14*s;CX.shadowColor='#40cc40';CX.beginPath();CX.arc(x,y-gh*.5,8*s,0,Math.PI*2);CX.fill();CX.restore();
    CX.restore();
  }
  CX.restore();

  // Tool hint on gate
  if(oa<.25){
    const bsc=.9+.18*pulse;
    CX.save();CX.translate(x+hw*.52,y-WH*SC*.9);CX.scale(bsc,bsc);
    CX.fillStyle=`rgba(255,${80+Math.floor(100*pulse)},0,.95)`;CX.beginPath();CX.arc(0,0,12*s,0,Math.PI*2);CX.fill();
    CX.strokeStyle='rgba(255,220,100,.65)';CX.lineWidth=2*s;CX.stroke();
    CX.fillStyle='#fff';CX.font=`bold ${15*s}px Arial`;CX.textAlign='center';CX.textBaseline='middle';CX.fillText('!',0,0);
    CX.restore();
    const boxW=hw*1.9,boxH=32*SC;
    const boxX=x-boxW/2,boxY=y-WH*SC*1.55;
    CX.save();
    CX.fillStyle='rgba(4,14,2,.88)';CX.strokeStyle=`rgba(${g.type==='vine_gate'?'100,200,60':'80,200,80'},${.8+.2*pulse})`;CX.lineWidth=2;
    CX.beginPath();CX.roundRect(boxX,boxY,boxW,boxH,6*SC);CX.fill();CX.stroke();
    CX.font=`800 ${9*SC}px 'Cinzel',serif`;CX.textAlign='center';CX.textBaseline='top';CX.fillStyle='rgba(255,255,255,.9)';
    CX.shadowColor='rgba(0,0,0,.9)';CX.shadowBlur=3;
    CX.fillText(gd.nm,x,boxY+3*SC);
    CX.font=`800 ${10*SC}px 'Nunito',sans-serif`;
    CX.fillStyle='rgba(180,255,120,1)';
    CX.fillText(`${gd.toolIco} Take ${gd.toolNm} ‚Üí skip!`,x,boxY+14*SC);
    CX.restore();
    const flt=Math.sin(Date.now()/600)*5*SC;
    CX.save();CX.font=`${20*SC}px serif`;CX.textAlign='center';CX.textBaseline='middle';CX.globalAlpha=.85+.15*pulse;CX.fillText(gd.toolIco,x-hw*.4,y-WH*SC*.65+flt);CX.restore();
  }
  gHits.push({c,r,g,cx:x,cy:y-WH*SC*.55,rad:36*s});
}

// ‚ïê‚ïê DECOR ‚ïê‚ïê
function drawDecor(c,r,type){
  drawFloor(c,r);const{x,y}=iso(c,r);const s=SC;CX.save();
  if(type==='plant'){
    CX.fillStyle='#2a8010';CX.beginPath();CX.ellipse(x,y-14*s,10*s,15*s,0,0,Math.PI*2);CX.fill();
    CX.fillStyle='#3caa1a';CX.beginPath();CX.ellipse(x+7*s,y-10*s,8*s,12*s,.5,0,Math.PI*2);CX.fill();
    CX.beginPath();CX.ellipse(x-7*s,y-10*s,8*s,12*s,-.5,0,Math.PI*2);CX.fill();
  } else if(type==='flower'){
    CX.strokeStyle='#2a7010';CX.lineWidth=2*s;CX.beginPath();CX.moveTo(x,y);CX.lineTo(x,y-18*s);CX.stroke();
    const fc=['#ff6090','#ff9030','#60e0ff','#ff60c0','#ffee30'];
    CX.fillStyle=fc[(c*7+r*11)%5];
    for(let a=0;a<6;a++){const ang=a*Math.PI*2/6;CX.beginPath();CX.ellipse(x+Math.cos(ang)*5.5*s,y-18*s+Math.sin(ang)*5.5*s,4.5*s,3*s,ang,0,Math.PI*2);CX.fill();}
    CX.fillStyle='#ffe262';CX.beginPath();CX.arc(x,y-18*s,3.5*s,0,Math.PI*2);CX.fill();
  } else if(type==='rock'){
    CX.fillStyle='#6a5a3a';CX.beginPath();CX.ellipse(x,y-7*s,11*s,8*s,0,0,Math.PI*2);CX.fill();
    CX.fillStyle='#8a7a50';CX.beginPath();CX.ellipse(x-2*s,y-9*s,8*s,6*s,.2,0,Math.PI*2);CX.fill();
    // Moss on rock
    CX.fillStyle='rgba(50,130,15,.6)';CX.beginPath();CX.ellipse(x,y-12*s,6*s,3*s,0,0,Math.PI*2);CX.fill();
  } else if(type==='torch'){
    // Bamboo torch
    CX.strokeStyle='#8ab830';CX.lineWidth=5*s;CX.lineCap='round';
    CX.beginPath();CX.moveTo(x,y);CX.lineTo(x,y-26*s);CX.stroke();
    CX.strokeStyle='#3a6008';CX.lineWidth=2*s;
    for(let j=0;j<3;j++){CX.beginPath();CX.moveTo(x-3*s,y-8*s*j);CX.lineTo(x+3*s,y-8*s*j);CX.stroke();}
    const fl=.6+.4*Math.sin(Date.now()/110+c+r);
    CX.save();CX.shadowBlur=18*s;CX.shadowColor=`rgba(255,180,40,${fl})`;
    CX.fillStyle=`rgba(255,${130+Math.floor(90*fl)},18,${.8+.2*fl})`;
    CX.beginPath();CX.ellipse(x,y-28*s,5*s,8*s,0,0,Math.PI*2);CX.fill();CX.restore();
  } else if(type==='mushroom'){
    CX.fillStyle='#e8d8a0';CX.fillRect(x-3*s,y-12*s,6*s,12*s);
    CX.fillStyle='#c83028';CX.beginPath();CX.arc(x,y-13*s,10*s,Math.PI,0);CX.fill();
    CX.fillStyle='rgba(255,255,255,.72)';for(const dx of[-4,0,4]){CX.beginPath();CX.arc(x+dx*s,y-15*s,2.2*s,0,Math.PI*2);CX.fill();}
  } else if(type==='fern'){
    for(let a=-4;a<=4;a++){
      CX.strokeStyle=`hsl(${108+a*4},60%,${24+Math.abs(a)*3}%)`;
      CX.lineWidth=2.2*s;CX.lineCap='round';
      CX.beginPath();CX.moveTo(x,y);CX.quadraticCurveTo(x+a*7*s,y-17*s,x+a*11*s,y-7*s);CX.stroke();
      // leaf
      CX.fillStyle=`rgba(${40+Math.abs(a)*8},${130+Math.abs(a)*10},${10+Math.abs(a)*5},.7)`;
      CX.beginPath();CX.ellipse(x+a*11*s,y-7*s,4*s,2*s,a*.3,0,Math.PI*2);CX.fill();
    }
  }
  CX.restore();
}

function drawExit(c,r){
  const t=Date.now()/600,p=.3+.25*Math.sin(t);const allDone=gates.every(g=>g.clr);
  drawFloor(c,r,allDone?'rgba(72,215,62,.9)':'rgba(55,148,44,.78)');
  const{x,y}=iso(c,r);const s=SC;
  if(allDone){CX.save();CX.shadowBlur=32*s;CX.shadowColor='rgba(80,255,80,.82)';CX.strokeStyle='rgba(80,255,80,.88)';CX.lineWidth=5*s;CX.beginPath();CX.arc(x,y-26*s,15*s,Math.PI,0);CX.stroke();CX.restore();}
  // bamboo door frame
  for(const dx of[-12,12]){
    CX.strokeStyle='#7ab028';CX.lineWidth=8*s;CX.lineCap='round';
    CX.beginPath();CX.moveTo(x+dx*s,y);CX.lineTo(x+dx*s,y-31*s);CX.stroke();
    // joints
    for(let j=0;j<3;j++){CX.strokeStyle='#3a6008';CX.lineWidth=3*s;CX.beginPath();CX.moveTo(x+dx*s-4*s,y-10*s*j);CX.lineTo(x+dx*s+4*s,y-10*s*j);CX.stroke();}
  }
  CX.strokeStyle='#7ab028';CX.lineWidth=6*s;CX.beginPath();CX.arc(x,y-26*s,14*s,Math.PI,0);CX.stroke();
  // leaves on top
  CX.font=`${18*s}px serif`;CX.textAlign='center';CX.fillText('üåø',x,y-38*s);
  CX.fillStyle=allDone?`rgba(50,${154+Math.floor(72*p)},36,.94)`:'rgba(20,50,10,.72)';CX.fillRect(x-12*s,y-26*s,24*s,26*s);
  if(allDone){
    CX.font=`${14*s}px serif`;CX.textAlign='center';
    CX.fillText('üåü',x-18*s,y-40*s);CX.fillText('‚ú®',x,y-44*s);CX.fillText('üåü',x+18*s,y-40*s);
  } else {
    const rem=gates.filter(g=>!g.clr).length;
    CX.font=`bold ${9*SC}px 'Cinzel',serif`;CX.textAlign='center';CX.fillStyle='rgba(255,255,255,.6)';CX.fillText(`${rem} gates left`,x,y-36*s);
  }
}

function drawArrows(){
  if(!arrowPath.length)return;
  arrowPath.slice(0,5).forEach((p,i)=>{
    const{x,y}=iso(p.col,p.row);const t2=Date.now()/500;
    const a=.4+.3*Math.sin(t2+i*.8),sc2=.85+.12*Math.sin(t2+i*.8);
    CX.save();CX.globalAlpha=a*(1-i/5*.55);CX.translate(x,y-WH*SC*.06);CX.scale(sc2,sc2);
    const as=14*SC;CX.fillStyle='#f0e030';CX.shadowBlur=12*SC;CX.shadowColor='rgba(240,224,48,.8)';
    CX.beginPath();CX.moveTo(0,-as);CX.lineTo(as*.6,-as*.2);CX.lineTo(as*.3,-as*.2);CX.lineTo(as*.3,as*.5);CX.lineTo(-as*.3,as*.5);CX.lineTo(-as*.3,-as*.2);CX.lineTo(-as*.6,-as*.2);CX.closePath();CX.fill();CX.restore();
  });
}

// ‚ïê‚ïê EXPLORER HERO ‚ïê‚ïê
function drawHero(cx,cy,fR,wt){
  const s=SC,flip=fR?1:-1;
  const isW=mPath.length>0||mTimer>0;
  const bob=isW?(Math.abs(Math.sin(wt*Math.PI*5))*4):Math.sin(Date.now()/560)*1.8;
  const lsw=isW?Math.sin(wt*Math.PI*5)*14:0;
  CX.save();CX.translate(cx,cy-bob*s);

  // Shadow
  CX.save();CX.globalAlpha=.22;CX.beginPath();CX.ellipse(0,2*s,16*s,6*s,0,0,Math.PI*2);CX.fillStyle='#000';CX.fill();CX.restore();

  // BOOTS ‚Äî brown hiking boots
  for(const[bx,bs]of[[-5,1],[3,-1]]){
    CX.fillStyle='#6a3a18';CX.fillRect((bx-1)*s*flip,-6*s,8*s,8*s);
    CX.fillStyle='#8a5228';CX.fillRect((bx-1)*s*flip,-9*s,8*s,4*s);
    // sole
    CX.fillStyle='#3a2008';CX.fillRect((bx-2)*s*flip,-2*s,10*s,3*s);
    // laces
    CX.strokeStyle='rgba(240,230,200,.5)';CX.lineWidth=.8*s;
    CX.beginPath();CX.moveTo((bx)*s*flip,-7*s);CX.lineTo((bx+4)*s*flip,-7*s);CX.stroke();
    CX.beginPath();CX.moveTo((bx)*s*flip,-5*s);CX.lineTo((bx+4)*s*flip,-5*s);CX.stroke();
  }

  // White socks visible above boots
  CX.fillStyle='rgba(240,238,230,.9)';
  CX.fillRect(-9*s,-10*s,7*s,4*s);
  CX.fillRect(3*s*flip,-10*s,7*s,4*s);

  // LEGS ‚Äî walking animation
  CX.save();CX.translate(-4*s*flip,0);CX.rotate((-lsw*Math.PI/180)*flip);
  // Green cargo shorts
  CX.fillStyle='#4a6a28';CX.fillRect(-4.5*s,-26*s,9*s,20*s);
  // cargo pocket
  CX.strokeStyle='rgba(0,0,0,.2)';CX.lineWidth=.8*s;CX.strokeRect(-4*s,-22*s,6*s,6*s);
  CX.restore();
  CX.save();CX.translate(4*s*flip,0);CX.rotate((lsw*Math.PI/180)*flip);
  CX.fillStyle='#3e5c22';CX.fillRect(-4.5*s,-26*s,9*s,20*s);
  CX.strokeStyle='rgba(0,0,0,.2)';CX.lineWidth=.8*s;CX.strokeRect(-4*s,-22*s,6*s,6*s);
  CX.restore();

  // BELT ‚Äî brown leather belt
  CX.fillStyle='#6a3a10';CX.fillRect(-11*s,-28*s,22*s,4*s);
  // belt buckle
  CX.strokeStyle='#c89040';CX.lineWidth=2*s;CX.strokeRect(-3.5*s,-28*s,7*s,4*s);
  CX.fillStyle='rgba(200,160,60,.5)';CX.fillRect(-3.5*s,-28*s,7*s,4*s);

  // SHOULDER BAG on left side (brown messenger bag)
  const bagSide=-flip;
  CX.save();
  CX.fillStyle='#7a4a20';
  CX.beginPath();CX.roundRect(bagSide*10*s,-30*s,12*s,14*s,3*s);CX.fill();
  CX.fillStyle='#6a3a10';
  CX.beginPath();CX.roundRect(bagSide*10*s,-30*s,12*s,4*s,3*s);CX.fill();
  // strap
  CX.strokeStyle='#5a3010';CX.lineWidth=2*s;CX.lineCap='round';
  CX.beginPath();CX.moveTo(bagSide*10*s,-30*s);CX.bezierCurveTo(bagSide*6*s,-44*s,0,-42*s,-bagSide*4*s,-36*s);CX.stroke();
  // buckle on bag
  CX.strokeStyle='#c89040';CX.lineWidth=1.5*s;CX.strokeRect(bagSide*14*s,-26*s,4*s,3*s);
  CX.restore();

  // TORSO ‚Äî white tank top
  CX.fillStyle='#f0ede0';CX.fillRect(-11*s,-52*s,22*s,26*s);
  // tank top straps
  CX.fillStyle='#e8e4d8';CX.fillRect(-10*s,-52*s,4*s,26*s);
  CX.fillRect(6*s,-52*s,4*s,26*s);
  // arm holes
  CX.fillStyle='#f5c090';// skin showing
  CX.fillRect(-13*s,-52*s,4*s,20*s);
  CX.fillRect(9*s,-52*s,4*s,20*s);
  // slight shadow on shirt center
  CX.fillStyle='rgba(0,0,0,.04)';CX.fillRect(-3*s,-52*s,6*s,20*s);

  // TATTOO on left arm ‚Äî orange flame/tribal
  const tattooArm=flip*12*s;
  CX.save();CX.globalAlpha=.85;
  CX.fillStyle='#cc4810';
  CX.beginPath();CX.moveTo(tattooArm,-42*s);CX.bezierCurveTo(tattooArm+2*s,-46*s,tattooArm+5*s,-44*s,tattooArm+3*s,-40*s);CX.bezierCurveTo(tattooArm+6*s,-43*s,tattooArm+8*s,-40*s,tattooArm+5*s,-37*s);CX.bezierCurveTo(tattooArm+2*s,-34*s,tattooArm-1*s,-36*s,tattooArm,-38*s);CX.closePath();CX.fill();
  CX.fillStyle='rgba(255,120,40,.6)';CX.beginPath();CX.moveTo(tattooArm+2*s,-40*s);CX.bezierCurveTo(tattooArm+3*s,-43*s,tattooArm+5*s,-42*s,tattooArm+4*s,-39*s);CX.closePath();CX.fill();
  CX.restore();

  // NECKLACE
  CX.save();CX.strokeStyle='rgba(200,160,80,.7)';CX.lineWidth=1*s;
  CX.beginPath();CX.arc(0,-52*s,6*s,0.3,Math.PI-.3);CX.stroke();
  // pendant
  CX.fillStyle='#506880';CX.beginPath();CX.arc(0,-46*s,2.5*s,0,Math.PI*2);CX.fill();
  CX.restore();

  // ARMS ‚Äî skin colored
  const asw=isW?Math.sin(wt*Math.PI*5+Math.PI)*16:0;
  // Left arm
  CX.save();CX.translate(-12*s*flip,-46*s);CX.rotate(((asw+12)*Math.PI/180)*flip);
  CX.fillStyle='#f0a870';// tanned skin
  CX.beginPath();CX.roundRect(-4*s,0,8*s,22*s,4*s);CX.fill();
  // subtle muscle
  CX.strokeStyle='rgba(0,0,0,.06)';CX.lineWidth=1.5*s;CX.beginPath();CX.moveTo(-2*s,4*s);CX.lineTo(-2*s,18*s);CX.stroke();
  // Hand
  CX.fillStyle='#f5b880';CX.beginPath();CX.arc(0,22*s,4.5*s,0,Math.PI*2);CX.fill();
  CX.restore();
  // Right arm
  CX.save();CX.translate(12*s*flip,-46*s);CX.rotate(((-asw-12)*Math.PI/180)*flip);
  CX.fillStyle='#e8a060';
  CX.beginPath();CX.roundRect(-4*s,0,8*s,22*s,4*s);CX.fill();
  CX.fillStyle='#f5b880';CX.beginPath();CX.arc(0,22*s,4.5*s,0,Math.PI*2);CX.fill();
  CX.restore();

  // NECK
  CX.fillStyle='#f0a870';CX.fillRect(-3.5*s,-58*s,7*s,8*s);

  // HEAD
  CX.fillStyle='#f0a870';// face skin
  CX.beginPath();CX.ellipse(0,-65*s,10*s,12*s,0,0,Math.PI*2);CX.fill();

  // HAIR ‚Äî dark brown medium length
  CX.fillStyle='#2a1808';
  CX.beginPath();CX.ellipse(0,-71*s,10.5*s,6*s,0,0,Math.PI*2);CX.fill();
  // hair sides / flowing
  CX.beginPath();CX.ellipse(-9*s,-65*s,5*s,9*s,-.2,0,Math.PI*2);CX.fill();
  CX.beginPath();CX.ellipse(9*s*flip,-65*s,4.5*s,8*s,.2,0,Math.PI*2);CX.fill();
  // a few hair strands
  CX.strokeStyle='#3a2410';CX.lineWidth=1.5*s;CX.lineCap='round';
  for(let h=0;h<3;h++){CX.beginPath();CX.moveTo(-8*s+h*4*s,-70*s);CX.quadraticCurveTo(-10*s+h*6*s,-64*s,-11*s+h*7*s,-58*s);CX.stroke();}

  // HEADBAND ‚Äî yellow/orange
  CX.fillStyle='#f0a010';
  CX.save();CX.beginPath();CX.ellipse(0,-70*s,11*s,3.5*s,.05,0,Math.PI*2);CX.fill();
  CX.fillStyle='#d08808';CX.beginPath();CX.ellipse(0,-70*s,11*s,1.5*s,.05,0,Math.PI*2);CX.fill();
  // headband knot at side
  CX.fillStyle='#e09010';CX.beginPath();CX.arc(9*s*flip,-70*s,4*s,0,Math.PI*2);CX.fill();
  CX.restore();

  // BEARD ‚Äî dark
  CX.fillStyle='#2a1808';
  CX.beginPath();CX.ellipse(0,-58*s,6*s,4.5*s,0,0,Math.PI*2);CX.fill();
  CX.beginPath();CX.ellipse(-5*s,-60*s,3*s,5*s,-.3,0,Math.PI*2);CX.fill();
  CX.beginPath();CX.ellipse(5*s,-60*s,3*s,5*s,.3,0,Math.PI*2);CX.fill();
  // slight texture on beard
  CX.fillStyle='#3a2410';CX.beginPath();CX.ellipse(0,-59*s,4*s,3*s,0,0,Math.PI*2);CX.fill();

  // EYES ‚Äî dark, expressive
  CX.fillStyle='#fff';for(const ex of[-3.8,2]){CX.beginPath();CX.ellipse(ex*s*flip,-66*s,3.2*s,2.4*s,0,0,Math.PI*2);CX.fill();}
  CX.fillStyle='#2a1808';for(const ex of[-3.8,2]){CX.beginPath();CX.ellipse(ex*s*flip,-66*s,2*s,2*s,0,0,Math.PI*2);CX.fill();}
  CX.fillStyle='rgba(255,255,255,.7)';for(const ex of[-3.8,2]){CX.beginPath();CX.arc((ex+1)*s*flip,-66.5*s,.8*s,0,Math.PI*2);CX.fill();}
  // Eyebrows
  CX.strokeStyle='#2a1808';CX.lineWidth=1.5*s;CX.lineCap='round';
  for(const ex of[-3.8,2]){CX.beginPath();CX.moveTo((ex-1.5)*s*flip,-69*s);CX.lineTo((ex+1.5)*s*flip,-69.5*s);CX.stroke();}

  // Active tool indicator
  if(curTool!=='t0'){
    const tic=TOOL_ICO[curTool];
    CX.font=`${14*s}px serif`;CX.textAlign='center';CX.fillText(tic,14*s*flip,-50*s);
    CX.save();CX.globalAlpha=.5+.5*Math.sin(Date.now()/300);CX.strokeStyle='#7ec850';CX.lineWidth=1.5;CX.strokeRect(10*s*flip-2*s,-56*s,12*s,12*s);CX.restore();
  }
  CX.restore();
}

// ‚ïê‚ïê NPC ‚ïê‚ïê
function drawNPC(c,r,npc){
  drawFloor(c,r,'rgba(80,180,60,.22)');
  const{x,y}=iso(c,r);const bob=Math.sin(Date.now()/720+c)*1.8;
  drawNpcChar(x,y-bob*SC,c>=pPos.col,npc.type);
  nHits.push({c,r,npc,cx:x,cy:y-32*SC,rad:22*SC});
}
function drawNpcChar(cx,cy,fR,type){
  const s=SC,flip=fR?1:-1;CX.save();CX.translate(cx,cy);
  if(type==='dog'){
    CX.fillStyle='#d4b880';CX.beginPath();CX.ellipse(0,-10*s,11*s,7*s,0,0,Math.PI*2);CX.fill();
    CX.fillStyle='#c0a060';CX.beginPath();CX.ellipse(9*s*flip,-14*s,8*s,6*s,0,0,Math.PI*2);CX.fill();
    CX.fillStyle='#a88040';CX.beginPath();CX.ellipse(12.5*s*flip,-18*s,3.5*s,5*s,-.3,0,Math.PI*2);CX.fill();
    CX.fillStyle='#1a0a04';CX.beginPath();CX.arc(11.5*s*flip,-14*s,1.8*s,0,Math.PI*2);CX.fill();
    CX.strokeStyle='#c0a060';CX.lineWidth=3.5*s;CX.lineCap='round';CX.beginPath();CX.moveTo(-9*s,-8*s);CX.bezierCurveTo(-15*s,-3*s,-17*s,3*s,-13*s,5*s);CX.stroke();
    for(const lx of[-5,5]){CX.fillStyle='#b89050';CX.fillRect((lx-2.5)*s,-6*s,5*s,10*s);}
    CX.restore();return;
  }
  const clr={old_man:'#708090',child:'#e04040',merchant:'#7a4a90'}[type]||'#3a7a3a';
  for(const lx of[-4,3]){CX.fillStyle='#5a8028';CX.fillRect((lx)*s*flip,-24*s,7*s,18*s);}
  CX.fillStyle=clr;CX.fillRect(-9*s,-52*s,18*s,28*s);
  CX.fillStyle='#f0a870';CX.beginPath();CX.ellipse(0,-58*s,9*s,11*s,0,0,Math.PI*2);CX.fill();
  CX.fillStyle='#2a1808';CX.beginPath();CX.ellipse(0,-65*s,9*s,6*s,0,0,Math.PI*2);CX.fill();
  CX.fillStyle='#1a0a04';for(const ex of[-3.5,2]){CX.beginPath();CX.arc(ex*s*flip,-58*s,1.8*s,0,Math.PI*2);CX.fill();}
  CX.restore();
}

function spawnP(sx,sy,ok){const e=ok?['‚≠ê','‚ú®','üí´','üåü','üçÉ']:['üí•','‚ùå','üí¢'];for(let i=0;i<8;i++)parts.push({x:sx,y:sy,vx:(Math.random()-.5)*2.5,vy:-(1.2+Math.random()*2),t:0,sz:(13+Math.random()*10)*SC,e:e[i%e.length]});}
function drawP(){parts=parts.filter(p=>{p.t+=.035;if(p.t>1)return false;CX.save();CX.globalAlpha=(1-p.t)*.9;CX.font=`${p.sz}px serif`;CX.textAlign='center';CX.textBaseline='middle';CX.fillText(p.e,p.x+p.vx*p.t*60,p.y+p.vy*p.t*60-22*p.t*p.t*SC);CX.restore();return true;});}
function drawPathDots(){
  if(!mPath.length)return;CX.save();
  mPath.forEach((p,i)=>{const{x,y}=iso(p.col,p.row);CX.globalAlpha=.5*(1-i/mPath.length);CX.fillStyle='rgba(126,200,80,.9)';CX.beginPath();CX.arc(x,y+2*SC,3.5*SC,0,Math.PI*2);CX.fill();});
  CX.restore();
}

function mkMinimap(){
  const cw=108,ch=108,cs=Math.min(Math.floor(cw/COLS),Math.floor(ch/ROWS));
  MX.clearRect(0,0,cw,ch);MX.fillStyle='#020e02';MX.fillRect(0,0,cw,ch);
  for(let r=0;r<ROWS;r++)for(let c=0;c<COLS;c++){
    if(maze[r][c]===1)MX.fillStyle='#3a5020';
    else if(r===exitPos.row&&c===exitPos.col)MX.fillStyle='#4caf50';
    else{const g=gates.find(g=>g.row===r&&g.col===c&&!g.clr);MX.fillStyle=g?'#ff5010':'#1e4010';}
    MX.fillRect(c*cs,r*cs,cs,cs);
  }
  arrowPath.slice(0,8).forEach(p=>{MX.fillStyle='rgba(240,224,48,.55)';MX.fillRect(p.col*cs,p.row*cs,cs,cs);});
  MX.fillStyle='#f0e040';MX.fillRect(pPos.col*cs-1,pPos.row*cs-1,cs+2,cs+2);
}

function lerp(a,b,t){return a+(b-a)*t;}
function updCam(){
  const{x:px,y:py}=iso(pPos.col,pPos.row);
  const cx=W/2,cy=(H-66)/2+66;const dx=W*.2,dy=H*.16;
  if(Math.abs(px-cx)>dx)ctX+=((px-cx)-(px>cx?dx:-dx))*.5;
  if(Math.abs(py-cy)>dy)ctY+=((py-cy)-(py>cy?dy:-dy))*.5;
  camX=lerp(camX,ctX,.1);camY=lerp(camY,ctY,.1);
}

function shuf(a){const b=[...a];for(let i=b.length-1;i>0;i--){const j=0|Math.random()*(i+1);[b[i],b[j]]=[b[j],b[i]];}return b;}
function buildMaze(){
  maze=Array.from({length:ROWS},()=>Array(COLS).fill(1));
  function carve(r,c){
    maze[r][c]=0;
    for(const[dr,dc]of shuf([[0,2],[0,-2],[2,0],[-2,0]])){
      const nr=r+dr,nc=c+dc;
      if(nr>0&&nr<ROWS-1&&nc>0&&nc<COLS-1&&maze[nr][nc]===1){maze[r+dr/2][c+dc/2]=0;carve(nr,nc);}
    }
  }
  carve(1,1);
  maze[exitPos.row][exitPos.col]=0;
  maze[Math.max(1,exitPos.row-1)][exitPos.col]=0;
  maze[exitPos.row][Math.max(1,exitPos.col-1)]=0;
  for(let i=0;i<7;i++){const r=1+Math.floor(Math.random()*(ROWS-2)),c=1+Math.floor(Math.random()*(COLS-2));maze[r][c]=0;}
  maze[1][1]=0;maze[1][2]=0;maze[2][1]=0;
}
function openCells(excl=[]){
  const out=[];
  for(let r=1;r<ROWS-1;r++)for(let c=1;c<COLS-1;c++){
    if(maze[r][c]===0&&!(r===1&&c<=2)&&!(r===exitPos.row&&c===exitPos.col)&&!excl.find(e=>e.row===r&&e.col===c))out.push({row:r,col:c});
  }
  return out;
}
function bfs(sc,sr,ec,er,thru=false){
  if(sc===ec&&sr===er)return[];
  const key=(c,r)=>c+','+r,q=[{c:sc,r:sr,p:[]}],vis=new Set([key(sc,sr)]);
  while(q.length){
    const{c,r,p}=q.shift();
    for(const[dc,dr]of[[0,-1],[0,1],[-1,0],[1,0]]){
      const nc=c+dc,nr=r+dr;
      if(nc<0||nr<0||nc>=COLS||nr>=ROWS||vis.has(key(nc,nr))||maze[nr][nc]===1)continue;
      const gh=!thru&&gates.find(g=>g.col===nc&&g.row===nr&&!g.clr);
      const np=[...p,{col:nc,row:nr}];
      if(nc===ec&&nr===er)return np;
      if(gh)continue;
      vis.add(key(nc,nr));q.push({c:nc,r:nr,p:np});
    }
  }
  return null;
}
function updArrows(){
  const rem=gates.filter(g=>!g.clr);
  if(!rem.length){arrowPath=bfs(pPos.col,pPos.row,exitPos.col,exitPos.row,true)||[];}
  else{
    let best=null,bd=9999;
    rem.forEach(g=>{const d=Math.abs(g.col-pPos.col)+Math.abs(g.row-pPos.row);if(d<bd){bd=d;best=g;}});
    arrowPath=best?bfs(pPos.col,pPos.row,best.col,best.row,true)||[]:[];
  }
  updQuest();
}
function updQuest(){
  const rem=gates.filter(g=>!g.clr).length;
  const r1=document.getElementById('qr1'),r2=document.getElementById('qr2');
  const r1t=document.getElementById('qr1t'),r2t=document.getElementById('qr2t');
  if(!rem){r1.className='qp-r done';r1t.textContent='All gates open! ‚úÖ';}
  else{r1.className='qp-r';r1t.textContent=`Open ${rem} more gate${rem>1?'s':''}‚Ä¶`;}
  if(!rem){r2.className='qp-r';r2t.textContent='‚Üí Go to the exit door!';}
  else{r2.className='qp-r';r2t.textContent='Exit locked until gates open';}
}
function setupLevel(){
  buildMaze();
  const gcnt=Math.min(4+curLvl*2,13);totGates=gcnt;clrObs=0;
  const cells=shuf(openCells());let used=[];
  gates=[];
  const gTypes=['iron_gate','vine_gate','rune_door','spike_gate'];
  cells.slice(0,gcnt).forEach((p,i)=>{gates.push({...p,clr:false,type:gTypes[i%4],oa:0});used.push(p);});
  npcs=[];
  shuf(cells).filter(p=>!used.find(u=>u.row===p.row&&u.col===p.col)).slice(0,Math.min(2,curLvl)).forEach((p,i)=>{npcs.push({...p,type:['old_man','child','dog','merchant'][i%4],ms:i%4});used.push(p);});
  decors=[];
  const dT=['plant','flower','rock','torch','mushroom','fern'];
  shuf(cells).filter(p=>!used.find(u=>u.row===p.row&&u.col===p.col)).slice(0,12+curLvl*2).forEach((p,i)=>{decors.push({...p,type:dT[i%6]});});
  verbQ=shuf([...VERBS]);mPath=[];opening=[];
  ST.hloss=0;ST.lacc=0;lvlTs=elapsed;lvlTot=0;lvlCorr=0;
  updArrows();
}

function stepMove(dt){
  if(inModal||!mPath.length)return;
  mTimer+=dt;
  if(mTimer>=MDUR){
    mTimer-=MDUR;
    const nxt=mPath.shift();if(!nxt)return;
    const g=gates.find(g=>g.col===nxt.col&&g.row===nxt.row&&!g.clr);
    if(g){mPath=[];mTimer=0;curGate=g;openChallenge();return;}
    if(nxt.col===exitPos.col&&nxt.row===exitPos.row){
      const rem=gates.filter(g=>!g.clr).length;
      if(!rem){pPos={...nxt};mPath=[];mTimer=0;setTimeout(doLvlComplete,400);return;}
      else{floatMsg(`Open ${rem} gate${rem>1?'s':''}!`,'bad');mPath=[];mTimer=0;return;}
    }
    if(nxt.col>pPos.col)facing=1;else if(nxt.col<pPos.col)facing=-1;
    pPos={...nxt};walkT=(walkT+.15)%1;
    updHUD();mkMinimap();updArrows();
  }
}
function walkTo(tc,tr){
  const path=bfs(pPos.col,pPos.row,tc,tr);
  if(!path){floatMsg('No path!','bad');return;}
  mPath=[...path];mTimer=0;
}

CV.addEventListener('click',e=>{
  if(!active||inModal)return;
  const rect=CV.getBoundingClientRect();
  const mx=(e.clientX-rect.left)*(CV.width/rect.width),my=(e.clientY-rect.top)*(CV.height/rect.height);
  showRing(e.clientX,e.clientY);
  for(const a of gHits){
    const dx=mx-a.cx,dy=my-a.cy;
    if(dx*dx+dy*dy<a.rad*a.rad){
      const dist=Math.abs(a.c-pPos.col)+Math.abs(a.r-pPos.row);
      if(curTool!=='t0'){useTool(a.g,a.c,a.r);return;}
      if(dist<=3){curGate=a.g;mPath=[];openChallenge();}
      else walkTo(a.c,a.r);
      return;
    }
  }
  for(const a of nHits){
    const dx=mx-a.cx,dy=my-a.cy;
    if(dx*dx+dy*dy<a.rad*a.rad){talkNPC(a.npc,a.cx,a.cy);return;}
  }
  const{col,row}=s2g(mx,my);
  if(col<0||row<0||col>=COLS||row>=ROWS||maze[row][col]===1)return;
  walkTo(col,row);
});
document.addEventListener('keydown',e=>{
  if(!active||inModal)return;
  const m={ArrowUp:[-1,0],ArrowDown:[1,0],ArrowLeft:[0,-1],ArrowRight:[0,1],w:[-1,0],s:[1,0],a:[0,-1],d:[0,1]};
  const[dr,dc]=m[e.key]||[];if(dr===undefined)return;e.preventDefault();
  walkTo(pPos.col+dc,pPos.row+dr);
});
let tx0=0,ty0=0;
CV.addEventListener('touchstart',e=>{tx0=e.touches[0].clientX;ty0=e.touches[0].clientY;},{passive:true});
CV.addEventListener('touchend',e=>{
  if(!active||inModal)return;
  const t=e.changedTouches[0];const dx=t.clientX-tx0,dy=t.clientY-ty0;
  if(Math.hypot(dx,dy)<30)CV.dispatchEvent(new MouseEvent('click',{clientX:t.clientX,clientY:t.clientY}));
},{passive:true});

let _rng=null;
function showRing(cx,cy){if(_rng)_rng.remove();_rng=document.createElement('div');_rng.style.cssText=`position:fixed;left:${cx-18}px;top:${cy-18}px;width:36px;height:36px;border-radius:50%;border:3px solid #7ec850;pointer-events:none;z-index:90;animation:rp .4s ease forwards`;const st=document.createElement('style');st.textContent='@keyframes rp{0%{transform:scale(.2);opacity:1}100%{transform:scale(1.8);opacity:0}}';document.head.appendChild(st);document.body.appendChild(_rng);setTimeout(()=>{_rng&&_rng.remove();_rng=null;},450);}

document.querySelectorAll('.ts').forEach(el=>{
  el.addEventListener('click',()=>{
    const id=el.id;
    if(id==='t0'){setTool('t0');return;}
    if((STOCK[id]||0)<=0){floatMsg('None left!','bad');return;}
    setTool(id);
  });
});
function setTool(id){
  curTool=id;
  document.querySelectorAll('.ts').forEach(el=>el.classList.toggle('on',el.id===id));
  const hints={t0:'Click to walk ¬∑ Click gates to answer',t1:'ü™ì Axe selected ‚Üí click a VINE WALL',t2:'‚õèÔ∏è Pick selected ‚Üí click STONE GATE or BAMBOO GATE',t3:'üóùÔ∏è Key selected ‚Üí click a RUNE DOOR',t4:'‚ú® Magic selected ‚Üí click ANY gate!'};
  document.getElementById('bbhint').textContent=hints[id]||'';
}
function useTool(g,c,r){
  const tid=curTool;
  if(!TOOL_COMPAT[tid].includes(g.type)){showWrongTool(tid,g.type);return;}
  STOCK[tid]--;
  document.getElementById('tc'+tid.slice(1)).textContent=STOCK[tid];
  if(STOCK[tid]<=0)document.getElementById(tid).classList.add('dim');
  setTool('t0');
  const fl=document.createElement('div');fl.style.cssText='position:fixed;inset:0;background:rgba(80,200,60,.15);z-index:90;pointer-events:none;animation:fl .4s ease forwards';const fst=document.createElement('style');fst.textContent='@keyframes fl{0%{opacity:1}100%{opacity:0}}';document.head.appendChild(fst);document.body.appendChild(fl);setTimeout(()=>fl.remove(),450);
  openingAnim(g);
  floatMsg(`${TOOL_ICO[tid]} Tool used! Gate destroyed!`,'tool');
  ST.tu++;clrObs++;ST.cl++;ST.tc++;coins-=5;
  setTimeout(()=>{g.clr=true;updHUD();mkMinimap();updArrows();checkAchs();},650);
}
function showWrongTool(tid,gtype){
  const msgs=WRONG_MSGS[tid]||{};const msg=msgs[gtype]||`${TOOL_ICO[tid]} Wrong tool for this gate!`;
  const gd=GATE_DATA[gtype];
  const wt=document.getElementById('wrongtool');
  document.getElementById('wt-ico').textContent='üö´';
  document.getElementById('wt-title').textContent='Wrong Tool!';
  document.getElementById('wt-msg').textContent=msg;
  document.getElementById('wt-suggest').textContent=`üëâ ${gd.toolIco} Take ${gd.toolNm} to open ${gd.nm}`;
  wt.classList.add('show');setTimeout(()=>wt.classList.remove('show'),2800);setTool('t0');
}
function openingAnim(g){opening.push({g,t:0});}
function updOpening(dt){opening.forEach(o=>{o.t+=dt*1.8;o.g.oa=Math.min(o.t,1);});opening=opening.filter(o=>o.t<1);}

function talkNPC(npc,sx,sy){
  const lines=NPC_LINES[npc.ms]||NPC_LINES[0];const msg=lines[Math.floor(Math.random()*lines.length)];
  const b=document.getElementById('spch');b.textContent=msg;b.style.left=(sx-90)+'px';b.style.top=Math.max(72,(sy-145*SC))+'px';b.style.display='block';
  clearTimeout(b._t);b._t=setTimeout(()=>b.style.display='none',3500);
}

function openChallenge(){
  if(!curGate)return;
  if(verbQ.length<2)verbQ=shuf([...VERBS]);
  curVerb=verbQ.pop();
  inModal=true;mPath=[];mTimer=0;
  const gd=GATE_DATA[curGate.type];
  const tid=gd.tool;const stock=STOCK[tid]||0;
  document.getElementById('mTier').textContent=TIER_LBL[curVerb.t]||'Common Verbs';
  document.getElementById('mGIco').textContent=gd.ic;
  document.getElementById('mGName').textContent=gd.nm;
  document.getElementById('mToolIco').textContent=gd.toolIco;
  document.getElementById('mToolMsg').textContent=stock>0?`Or use ${gd.toolNm} to skip (${stock} left)`:`No ${gd.toolNm} left ‚Äî answer to pass!`;
  const skipBtn=document.getElementById('mSkipBtn');
  if(stock>0){
    skipBtn.classList.remove('hidden');
    document.getElementById('mSkipIco').textContent=gd.toolIco;
    document.getElementById('mSkipMain').textContent=`Use ${gd.toolNm} to instantly destroy this gate!`;
    document.getElementById('mSkipSub').textContent=`${stock} use${stock>1?'s':''} remaining ‚Äî no question needed`;
  } else {skipBtn.classList.add('hidden');}
  const sent=SENTS[Math.floor(Math.random()*SENTS.length)];
  document.getElementById('mSent').innerHTML=sent.replace('______',`<span class="m-blank">______</span>`);
  document.getElementById('mBase').textContent=`Base form: "${curVerb.b}"`;
  document.getElementById('mFb').textContent='';document.getElementById('mFb').className='m-fb';
  document.getElementById('mStr').textContent=ST.str;
  document.getElementById('mAcc').textContent=totAns>0?Math.round(corrAns/totAns*100)+'%':'‚Äî';
  const opts=shuf([{t:curVerb.p,ok:true},{t:curVerb.d[0],ok:false},{t:curVerb.d[1],ok:false}]);
  const oc=document.getElementById('mOpts');oc.innerHTML='';
  ['A','B','C'].forEach((l,i)=>{
    const b=document.createElement('button');b.className='m-opt';
    b.innerHTML=`<span class="ol">${l}</span>${opts[i].t}`;
    b.addEventListener('click',()=>answer(opts[i],b));
    oc.appendChild(b);
  });
  document.getElementById('modal').classList.remove('hidden');
}

document.getElementById('mSkipBtn').addEventListener('click',()=>{
  if(!curGate)return;
  const gd=GATE_DATA[curGate.type];const tid=gd.tool;
  if((STOCK[tid]||0)<=0)return;
  STOCK[tid]--;
  document.getElementById('tc'+tid.slice(1)).textContent=STOCK[tid];
  if(STOCK[tid]<=0)document.getElementById(tid).classList.add('dim');
  document.getElementById('modal').classList.add('hidden');inModal=false;
  openingAnim(curGate);showGateBanner();
  ST.tu++;clrObs++;ST.cl++;ST.tc++;
  setTimeout(()=>{if(curGate){curGate.clr=true;curGate=null;}updHUD();mkMinimap();updArrows();checkAchs();},650);
  floatMsg(`${TOOL_ICO[tid]} Skipped!`,'tool');
});

function answer(opt,btn){
  document.querySelectorAll('.m-opt').forEach(b=>b.disabled=true);totAns++;lvlTot++;
  const{x:px,y:py}=iso(pPos.col,pPos.row);
  if(opt.ok){
    corrAns++;lvlCorr++;score+=5;xp=Math.min(xp+15,100);coins+=10;clrObs++;ST.cl++;ST.tc++;ST.cor++;ST.str++;
    btn.classList.add('ok');
    document.getElementById('mFb').textContent=`‚úÖ  "${curVerb.b}" ‚Üí "${curVerb.p}"  Excellent!`;
    document.getElementById('mFb').className='m-fb ok';
    floatMsg(`‚úÖ +5pts  +10ü™ô`,'ok');spawnP(px,py,true);
    setTimeout(()=>{
      document.getElementById('modal').classList.add('hidden');inModal=false;
      if(curGate){openingAnim(curGate);showGateBanner();}
      setTimeout(()=>{if(curGate){curGate.clr=true;curGate=null;}updHUD();mkMinimap();updArrows();checkAchs();},650);
    },900);
  } else {
    hp=Math.max(0,hp-1);score=Math.max(0,score-3);ST.str=0;ST.hloss++;
    btn.classList.add('bad');
    document.querySelectorAll('.m-opt').forEach(b=>{if(!b.disabled&&b.innerHTML.includes(curVerb.p))b.classList.add('ok');});
    document.getElementById('mFb').textContent=`‚ùå  Correct answer: "${curVerb.p}"`;
    document.getElementById('mFb').className='m-fb bad';
    floatMsg(`‚ùå Wrong! ‚àí3pts`,'bad');spawnP(px,py,false);updHUD();
    if(hp<=0){setTimeout(()=>{document.getElementById('modal').classList.add('hidden');inModal=false;doGameEnd(false);},1400);return;}
    setTimeout(()=>{document.getElementById('modal').classList.add('hidden');inModal=false;curGate=null;updArrows();},1500);
  }
}

document.getElementById('hintBtn').addEventListener('click',()=>{
  if(!inModal||!curVerb)return;
  if(coins<5){floatMsg('Not enough coins!','bad');return;}
  coins-=5;updHUD();
  document.querySelectorAll('.m-opt').forEach(b=>{if(!b.disabled&&b.innerHTML.includes(curVerb.p)){b.style.outline='4px solid #4caf50';b.style.background='linear-gradient(180deg,#c8f0c0,#90d880)';}});
  floatMsg('üí° Hint! ‚àí5ü™ô','coin');
});

function showGateBanner(){
  const msgs=['üîì Path Clear!','üåø Gate Opened!','üåü Excellent!','‚úÖ Passage Open!','üéØ Perfect Answer!'];
  const b=document.getElementById('gbanner');b.textContent=msgs[Math.floor(Math.random()*msgs.length)];
  b.classList.add('show');setTimeout(()=>b.classList.remove('show'),1600);
}

function checkAchs(){
  ACHS.forEach(a=>{if(!achDone.has(a.id)&&a.fn(ST)){achDone.add(a.id);showAch(a);}});
}
function showAch(a){
  document.getElementById('ati').textContent=a.ic;document.getElementById('atn').textContent=a.nm;document.getElementById('ats').textContent=a.ds;
  const el=document.getElementById('achtoast');el.classList.add('show');setTimeout(()=>el.classList.remove('show'),3200);
}

function doLvlComplete(){
  active=false;
  ST.lt=elapsed-lvlTs;
  if(lvlTot>0)ST.lacc=Math.round(lvlCorr/lvlTot*100);
  ST.lvc++;
  const acc=totAns>0?Math.round(corrAns/totAns*100):100;
  const rwd=40+curLvl*12;coins+=rwd;gems+=2+Math.floor(curLvl/2);
  document.getElementById('lcT').textContent=curLvl>=TOTAL_LVL?'All Levels Cleared! üèÜ':'Section Cleared!';
  document.getElementById('lcS').textContent=curLvl>=TOTAL_LVL?'You conquered the whole jungle!':'A deeper jungle awaits‚Ä¶';
  document.getElementById('lcSc').textContent=score;document.getElementById('lcAc').textContent=acc+'%';
  document.getElementById('lcTm').textContent=fmtT(elapsed);document.getElementById('lcRw').textContent=`+${rwd}ü™ô`;
  document.getElementById('lcAh').innerHTML=[...achDone].slice(-4).map(id=>{const a=ACHS.find(a=>a.id===id);return a?`<span class="ab">${a.ic} ${a.nm}</span>`:''}).join('');
  document.getElementById('lvc').classList.remove('hidden');confetti();checkAchs();
}
document.getElementById('nextBtn').addEventListener('click',()=>{
  document.getElementById('lvc').classList.add('hidden');
  if(curLvl>=TOTAL_LVL){doGameEnd(true);return;}
  curLvl++;pPos={col:1,row:1};camX=camY=ctX=ctY=0;mPath=[];mTimer=0;opening=[];
  setupLevel();updHUD();mkMinimap();active=true;
});
function doGameEnd(won){
  active=false;clearInterval(timerID);
  const acc=totAns>0?Math.round(corrAns/totAns*100):100;
  document.getElementById('geT').textContent=won?`${playerName} ‚Äî Jungle Champion!`:`${playerName} ‚Äî Lost in the Jungle‚Ä¶`;
  document.getElementById('geSc').textContent=score;document.getElementById('geAc').textContent=acc+'%';
  document.getElementById('geTm').textContent=fmtT(elapsed);document.getElementById('geLv').textContent=curLvl;
  document.getElementById('geAh').innerHTML=[...achDone].map(id=>{const a=ACHS.find(a=>a.id===id);return a?`<span class="ab">${a.ic} ${a.nm}</span>`:''}).join('');
  document.getElementById('ge').classList.remove('hidden');if(won)confetti();
}
document.getElementById('replayBtn').addEventListener('click',()=>{document.getElementById('ge').classList.add('hidden');document.getElementById('ss').classList.remove('hidden');});

function updHUD(){
  document.getElementById('hpBar').style.width=(hp/mhp*100)+'%';document.getElementById('hpVal').textContent=`${hp}/${mhp}`;
  document.getElementById('xpBar').style.width=(xp)+'%';document.getElementById('xpVal').textContent=`${xp}/100`;
  document.getElementById('avLv').textContent=lvl;document.getElementById('lvNum').textContent=curLvl;
  document.getElementById('coinC').textContent=coins;document.getElementById('gemC').textContent=gems;
  const pct=totGates>0?Math.round(clrObs/totGates*100):0;
  document.getElementById('progFg').style.width=pct+'%';document.getElementById('progTxt').textContent=`${clrObs}/${totGates} gates`;
  document.getElementById('progLbl').textContent=`Level ${curLvl} ‚Äî ${clrObs>=totGates?'Find the exit!':'Open all gates!'}`;
  Object.keys(STOCK).forEach(k=>{document.getElementById('tc'+k.slice(1)).textContent=STOCK[k];document.getElementById(k).classList.toggle('dim',STOCK[k]<=0);});
}
function fmtT(s){const m=Math.floor(s/60);return`${String(m).padStart(2,'0')}:${String(s%60).padStart(2,'0')}`;}
function floatMsg(text,cls){const el=document.createElement('div');el.className=`ft ${cls}`;el.textContent=text;el.style.left=(W/2-70)+'px';el.style.top=(H/2-60)+'px';document.body.appendChild(el);setTimeout(()=>el.remove(),1400);}
function confetti(){const cs=['#7ec850','#4caf50','#2196f3','#ff9800','#e91e63','#fff','#ffeb3b'];for(let i=0;i<90;i++)setTimeout(()=>{const c=document.createElement('div');c.className='cf';c.style.cssText=`left:${Math.random()*100}vw;top:-8px;width:${5+Math.random()*9}px;height:${5+Math.random()*9}px;background:${cs[0|Math.random()*cs.length]};border-radius:${Math.random()>.5?'50%':'2px'};animation-duration:${2+Math.random()*2.5}s`;document.body.appendChild(c);setTimeout(()=>c.remove(),5e3);},i*48);}
document.getElementById('pauseBtn').addEventListener('click',()=>{active=!active;document.getElementById('pauseBtn').textContent=active?'‚è∏ Pause':'‚ñ∂ Resume';});

function render(ts){
  requestAnimationFrame(render);
  if(!document.getElementById('ss').classList.contains('hidden'))return;
  const dt=Math.min((ts-lastTs)/1000,.05);lastTs=ts;
  if(active&&!paused){stepMove(dt);updCam();updOpening(dt);}
  CX.clearRect(0,0,W,H);
  drawBg();
  gHits=[];nHits=[];
  for(let r=0;r<ROWS;r++){
    for(let c=0;c<COLS;c++){
      if(maze[r][c]===1){drawWall(c,r);}
      else{
        const g=gates.find(g=>g.row===r&&g.col===c&&!g.clr);
        const npc=npcs.find(n=>n.row===r&&n.col===c);
        const dec=decors.find(d=>d.row===r&&d.col===c);
        if(r===exitPos.row&&c===exitPos.col)drawExit(c,r);
        else if(g)drawGate(c,r,g,gates.indexOf(g));
        else if(dec)drawDecor(c,r,dec.type);
        else drawFloor(c,r);
        if(npc)drawNPC(c,r,npc);
      }
    }
  }
  drawArrows();
  drawPathDots();
  const doff=facing===1?-1:1,dc2=Math.max(1,Math.min(COLS-2,pPos.col+doff));
  if(maze[pPos.row]&&maze[pPos.row][dc2]===0){const{x:dx2,y:dy2}=iso(dc2,pPos.row);drawNpcChar(dx2,dy2,facing===1,'dog');}
  const{x:px,y:py}=iso(pPos.col,pPos.row);drawHero(px,py,facing===1,walkT);
  drawP();
}

function init(){
  score=0;hp=mhp;xp=0;lvl=1;coins=100;gems=5;
  totAns=0;corrAns=0;clrObs=0;curLvl=1;
  parts=[];curGate=null;curVerb=null;
  pPos={col:1,row:1};exitPos={col:COLS-2,row:ROWS-2};
  facing=1;walkT=0;mPath=[];mTimer=0;opening=[];
  inModal=false;active=false;camX=camY=ctX=ctY=0;
  ST={cl:0,str:0,tu:0,tc:0,cor:0,lvc:0,hloss:0,lt:0,lacc:0};
  achDone=new Set();STOCK.t1=3;STOCK.t2=2;STOCK.t3=1;STOCK.t4=1;
  setTool('t0');setupLevel();resize();updHUD();mkMinimap();
  clearInterval(timerID);elapsed=0;
  timerID=setInterval(()=>{if(active&&!paused){elapsed++;document.getElementById('timer').textContent=fmtT(elapsed);}},1000);
  active=true;
}

document.getElementById('startBtn').addEventListener('click',()=>{
  playerName=document.getElementById('nameIn').value.trim()||'Explorer';
  document.getElementById('ss').classList.add('hidden');init();
});
document.getElementById('nameIn').addEventListener('keydown',e=>{if(e.key==='Enter')document.getElementById('startBtn').click();});
window.addEventListener('resize',()=>{resize();mkMinimap();});
resize();requestAnimationFrame(render);
})();
</script>
</div>
</body>
</html>
